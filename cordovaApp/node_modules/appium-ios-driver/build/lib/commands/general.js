'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _js2xmlparser2 = require("js2xmlparser2");

var _js2xmlparser22 = _interopRequireDefault(_js2xmlparser2);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _utils = require('../utils');

var _utils2 = _interopRequireDefault(_utils);

var commands = {},
    helpers = {},
    extensions = {};

commands.active = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('active_element', []));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.getActiveElement()"));

      case 8:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getDeviceTime = function callee$0$0() {
  var idevicedate, _ref, stdout, date;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info('Attempting to capture iOS device date and time');

        if (!this.isRealDevice()) {
          context$1$0.next = 20;
          break;
        }

        context$1$0.prev = 2;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('idevicedate'));

      case 5:
        idevicedate = context$1$0.sent;

        _logger2['default'].info('Found idevicedate: \'' + idevicedate + '\'');
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(idevicedate, ['-u', this.opts.udid]));

      case 9:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        date = new Date(stdout.trim());
        return context$1$0.abrupt('return', date.toString());

      case 15:
        context$1$0.prev = 15;
        context$1$0.t0 = context$1$0['catch'](2);

        _logger2['default'].errorAndThrow('Could not capture device date and time using libimobiledevice idevicedate. ' + 'Libimobiledevice is probably not installed');

      case 18:
        context$1$0.next = 22;
        break;

      case 20:
        _logger2['default'].warn('On simulator. Assuming device time is the same as host time');
        return context$1$0.abrupt('return', new Date().toString());

      case 22:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 15]]);
};

commands.hideKeyboard = function callee$0$0(strategy) {
  for (var _len = arguments.length, possibleKeys = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    possibleKeys[_key - 1] = arguments[_key];
  }

  var cmd, key;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        possibleKeys.pop(); // last parameter is the session id
        cmd = undefined;
        key = _lodash2['default'].find(possibleKeys, function (k) {
          return k;
        });

        if (key) {
          strategy = strategy || 'pressKey';
          cmd = 'au.hideKeyboard(\'' + strategy + '\', \'' + key + '\')';
        } else {
          strategy = strategy || 'default';
          cmd = 'au.hideKeyboard(\'' + strategy + '\')';
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(cmd));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getPageSource = function callee$0$0() {
  var cmd, jsonSource, xmlSource;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 7;
          break;
        }

        cmd = 'document.getElementsByTagName("html")[0].outerHTML';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.remote.execute(cmd));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getSourceForElementForXML());

      case 9:
        jsonSource = context$1$0.sent;

        if (typeof jsonSource === "string") {
          jsonSource = JSON.parse(jsonSource);
        }
        xmlSource = (0, _js2xmlparser22['default'])("AppiumAUT", jsonSource, {
          wrapArray: { enabled: false, elementName: "element" },
          declaration: { include: true },
          prettyPrinting: { indentString: "    " }
        });
        return context$1$0.abrupt('return', xmlSource);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.background = function callee$0$0(secs) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.background(' + secs + ')'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.lock = function callee$0$0(secs) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!secs) {
          _logger2['default'].debug('No seconds parameter. Using 0 seconds');
          secs = 0;
        }
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.lock(' + secs + ')'));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.closeApp = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.stop());

      case 3:
        _logger2['default'].info('Successfully closed the [' + this.opts.app + '] app.');
        context$1$0.next = 10;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](0);

        _logger2['default'].warn('Something went wrong while closing the [' + this.opts.app + '] app.');
        throw context$1$0.t0;

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 6]]);
};

commands.launchApp = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.start());

      case 3:
        _logger2['default'].info('Successfully launched the [' + this.opts.app + '] app.');
        context$1$0.next = 10;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](0);

        _logger2['default'].warn('Something went wrong while launching the [' + this.opts.app + '] app.');
        throw context$1$0.t0;

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 6]]);
};

commands.removeApp = function callee$0$0(bundleId) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isRealDevice()) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.realDevice.remove(bundleId));

      case 3:
        context$1$0.next = 7;
        break;

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.sim.removeApp(bundleId));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.keys = function callee$0$0(keys) {
  var el, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.active());

      case 3:
        el = context$1$0.sent;

        if (!_lodash2['default'].isUndefined(el.ELEMENT)) {
          context$1$0.next = 6;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchElementError();

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.setValue(keys, el.ELEMENT));

      case 8:
        context$1$0.next = 16;
        break;

      case 10:
        if (_lodash2['default'].isArray(keys)) {
          keys = keys.join('');
        }
        if (!_lodash2['default'].isString(keys)) {
          keys = keys.toString();
        }
        keys = _appiumSupport.util.escapeSpecialChars(keys, "'");
        command = 'au.sendKeysToActiveElement(\'' + keys + '\')';
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setGeoLocation = function callee$0$0(location) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('target.setLocation(' + JSON.stringify(location) + ')'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

//}
commands.getWindowSize = function callee$0$0() {
  var windowHandle = arguments.length <= 0 || arguments[0] === undefined ? "current" : arguments[0];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(windowHandle !== "current")) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError("Currently only getting current window size is supported.");

      case 2:
        if (!this.isWebContext()) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('get_window_size', []));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.getWindowSize()"));

      case 10:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getStrings = function callee$0$0(language) {
  var stringFile = arguments.length <= 1 || arguments[1] === undefined ? null : arguments[1];
  var strings;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Gettings strings for language \'' + language + '\' and string file \'' + stringFile + '\'');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_utils2['default'].parseLocalizableStrings(_lodash2['default'].defaults({ language: language, stringFile: stringFile }, this.opts)));

      case 3:
        strings = context$1$0.sent;

        if (strings && strings.length >= 1) {
          strings = strings[0];
        }
        return context$1$0.abrupt('return', strings);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// TODO: check the hasOptions bit, the method signature should be location, option

//let hasOptions = altitude !== null || horizontalAccuracy !== null || verticalAccuracy !== null || course !== null || speed !== null;
//if (hasOptions) {
//let options = {};
//if (altitude !== null) {
//options.altitude = altitude;
//}
//if (horizontalAccuracy !== null) {
//options.horizontalAccuracy = horizontalAccuracy;
//}
//if (verticalAccuracy !== null) {
//options.verticalAccuracy = verticalAccuracy;
//}
//if (course !== null) {
//options.course = course;
//}
//if (speed !== null) {
//options.speed = speed;
//}
//await this.uiAutoClient.sendCommand(
//`target.setLocationWithOptions(${JSON.stringify(coordinates)}, ${JSON.stringify(options)})`);
//} else {
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBdUIsb0JBQW9COztzQkFDN0IsUUFBUTs7Ozs2QkFDSCxlQUFlOzs7O3NCQUNsQixXQUFXOzs7OzZCQUNGLGdCQUFnQjs7NEJBQ3BCLGNBQWM7O3FCQUNqQixVQUFVOzs7O0FBRzVCLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELFFBQVEsQ0FBQyxNQUFNLEdBQUc7Ozs7YUFDWixJQUFJLENBQUMsWUFBWSxFQUFFOzs7Ozs7eUNBQ1IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLENBQUM7Ozs7Ozs7eUNBRXRDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLHVCQUF1QixDQUFDOzs7Ozs7Ozs7O0NBRXRFLENBQUM7O0FBRUYsUUFBUSxDQUFDLGFBQWEsR0FBRztNQUlmLFdBQVcsUUFFVixNQUFNLEVBQ1AsSUFBSTs7Ozs7QUFOWiw0QkFBSSxJQUFJLENBQUMsZ0RBQWdELENBQUMsQ0FBQzs7YUFDdkQsSUFBSSxDQUFDLFlBQVksRUFBRTs7Ozs7Ozt5Q0FFSyxrQkFBRyxLQUFLLENBQUMsYUFBYSxDQUFDOzs7QUFBM0MsbUJBQVc7O0FBQ2YsNEJBQUksSUFBSSwyQkFBd0IsV0FBVyxRQUFJLENBQUM7O3lDQUMzQix3QkFBSyxXQUFXLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzs7OztBQUF6RCxjQUFNLFFBQU4sTUFBTTtBQUNQLFlBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7NENBQzNCLElBQUksQ0FBQyxRQUFRLEVBQUU7Ozs7OztBQUV0Qiw0QkFBSSxhQUFhLENBQUMsNkVBQTZFLEdBQ2hGLDRDQUE0QyxDQUFDLENBQUM7Ozs7Ozs7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UUFBUSxDQUFDLE9BQUk7Ozs7Ozs7Q0FFdkYsQ0FBQzs7O0FBRUYsUUFBUSxDQUFDLGFBQWEsR0FBRztNQUFnQixZQUFZLHlEQUFDLFNBQVM7Ozs7Y0FDekQsWUFBWSxLQUFLLFNBQVMsQ0FBQTs7Ozs7Y0FDdEIsSUFBSSx5QkFBTyxzQkFBc0IsQ0FBQywwREFBMEQsQ0FBQzs7O2FBR2pHLElBQUksQ0FBQyxZQUFZLEVBQUU7Ozs7Ozt5Q0FDUixJQUFJLENBQUMsV0FBVyxDQUFDLGlCQUFpQixFQUFFLEVBQUUsQ0FBQzs7Ozs7Ozt5Q0FFdkMsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUM7Ozs7Ozs7Ozs7Q0FFbkUsQ0FBQzs7QUFFRixRQUFRLENBQUMsVUFBVSxHQUFHLG9CQUFnQixRQUFRO01BQUUsVUFBVSx5REFBRyxJQUFJO01BRTNELE9BQU87Ozs7QUFEWCw0QkFBSSxLQUFLLHNDQUFtQyxRQUFRLDZCQUFzQixVQUFVLFFBQUksQ0FBQzs7eUNBQ3JFLG1CQUFNLHVCQUF1QixDQUFDLG9CQUFFLFFBQVEsQ0FBQyxFQUFDLFFBQVEsRUFBUixRQUFRLEVBQUUsVUFBVSxFQUFWLFVBQVUsRUFBQyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzs7O0FBQTVGLGVBQU87O0FBQ1gsWUFBSSxPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7QUFDbEMsaUJBQU8sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDdEI7NENBQ00sT0FBTzs7Ozs7OztDQUNmLENBQUM7O0FBR0YsZUFBYyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3BDLFFBQVEsR0FBUixRQUFRO1FBQUUsT0FBTyxHQUFQLE9BQU87cUJBQ1gsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvZ2VuZXJhbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGpzMnhtbCBmcm9tIFwianMyeG1scGFyc2VyMlwiO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZnMsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB1dGlscyBmcm9tICcuLi91dGlscyc7XG5cblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb21tYW5kcy5hY3RpdmUgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2FjdGl2ZV9lbGVtZW50JywgW10pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcImF1LmdldEFjdGl2ZUVsZW1lbnQoKVwiKTtcbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0RGV2aWNlVGltZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbG9nLmluZm8oJ0F0dGVtcHRpbmcgdG8gY2FwdHVyZSBpT1MgZGV2aWNlIGRhdGUgYW5kIHRpbWUnKTtcbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICB0cnkge1xuICAgICAgbGV0IGlkZXZpY2VkYXRlID0gYXdhaXQgZnMud2hpY2goJ2lkZXZpY2VkYXRlJyk7XG4gICAgICBsb2cuaW5mbyhgRm91bmQgaWRldmljZWRhdGU6ICcke2lkZXZpY2VkYXRlfSdgKTtcbiAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoaWRldmljZWRhdGUsIFsnLXUnLCB0aGlzLm9wdHMudWRpZF0pO1xuICAgICAgbGV0IGRhdGUgPSBuZXcgRGF0ZShzdGRvdXQudHJpbSgpKTtcbiAgICAgIHJldHVybiBkYXRlLnRvU3RyaW5nKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdygnQ291bGQgbm90IGNhcHR1cmUgZGV2aWNlIGRhdGUgYW5kIHRpbWUgdXNpbmcgbGliaW1vYmlsZWRldmljZSBpZGV2aWNlZGF0ZS4gJyArXG4gICAgICAgICAgICAgICAgICAgICAnTGliaW1vYmlsZWRldmljZSBpcyBwcm9iYWJseSBub3QgaW5zdGFsbGVkJyk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxvZy53YXJuKCdPbiBzaW11bGF0b3IuIEFzc3VtaW5nIGRldmljZSB0aW1lIGlzIHRoZSBzYW1lIGFzIGhvc3QgdGltZScpO1xuICAgIHJldHVybiBuZXcgRGF0ZSgpLnRvU3RyaW5nKCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmhpZGVLZXlib2FyZCA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgLi4ucG9zc2libGVLZXlzKSB7XG4gIHBvc3NpYmxlS2V5cy5wb3AoKTsgLy8gbGFzdCBwYXJhbWV0ZXIgaXMgdGhlIHNlc3Npb24gaWRcbiAgbGV0IGNtZDtcbiAgbGV0IGtleSA9IF8uZmluZChwb3NzaWJsZUtleXMsIChrKSA9PiB7cmV0dXJuIGs7fSk7XG4gIGlmIChrZXkpIHtcbiAgICBzdHJhdGVneSA9IHN0cmF0ZWd5IHx8ICdwcmVzc0tleSc7XG4gICAgY21kID0gYGF1LmhpZGVLZXlib2FyZCgnJHtzdHJhdGVneX0nLCAnJHtrZXl9JylgO1xuICB9IGVsc2Uge1xuICAgIHN0cmF0ZWd5ID0gc3RyYXRlZ3kgfHwgJ2RlZmF1bHQnO1xuICAgIGNtZCA9IGBhdS5oaWRlS2V5Ym9hcmQoJyR7c3RyYXRlZ3l9JylgO1xuICB9XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNtZCk7XG59O1xuXG5jb21tYW5kcy5nZXRQYWdlU291cmNlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBjbWQgPSAnZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJodG1sXCIpWzBdLm91dGVySFRNTCc7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucmVtb3RlLmV4ZWN1dGUoY21kKTtcbiAgfSBlbHNlIHtcbiAgICBsZXQganNvblNvdXJjZSA9IGF3YWl0IHRoaXMuZ2V0U291cmNlRm9yRWxlbWVudEZvclhNTCgpO1xuICAgIGlmICh0eXBlb2YganNvblNvdXJjZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAganNvblNvdXJjZSA9IEpTT04ucGFyc2UoanNvblNvdXJjZSk7XG4gICAgfVxuICAgIGxldCB4bWxTb3VyY2UgPSBqczJ4bWwoXCJBcHBpdW1BVVRcIiwganNvblNvdXJjZSwge1xuICAgICAgd3JhcEFycmF5OiB7ZW5hYmxlZDogZmFsc2UsIGVsZW1lbnROYW1lOiBcImVsZW1lbnRcIn0sXG4gICAgICBkZWNsYXJhdGlvbjoge2luY2x1ZGU6IHRydWV9LFxuICAgICAgcHJldHR5UHJpbnRpbmc6IHtpbmRlbnRTdHJpbmc6IFwiICAgIFwifVxuICAgIH0pO1xuICAgIHJldHVybiB4bWxTb3VyY2U7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmJhY2tncm91bmQgPSBhc3luYyBmdW5jdGlvbiAoc2Vjcykge1xuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgYXUuYmFja2dyb3VuZCgke3NlY3N9KWApO1xufTtcblxuY29tbWFuZHMubG9jayA9IGFzeW5jIGZ1bmN0aW9uIChzZWNzKSB7XG4gIGlmICghc2Vjcykge1xuICAgIGxvZy5kZWJ1ZygnTm8gc2Vjb25kcyBwYXJhbWV0ZXIuIFVzaW5nIDAgc2Vjb25kcycpO1xuICAgIHNlY3MgPSAwO1xuICB9XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGBhdS5sb2NrKCR7c2Vjc30pYCk7XG59O1xuXG5jb21tYW5kcy5jbG9zZUFwcCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLnN0b3AoKTtcbiAgICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IGNsb3NlZCB0aGUgWyR7dGhpcy5vcHRzLmFwcH1dIGFwcC5gKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFNvbWV0aGluZyB3ZW50IHdyb25nIHdoaWxlIGNsb3NpbmcgdGhlIFske3RoaXMub3B0cy5hcHB9XSBhcHAuYCk7XG4gICAgdGhyb3cgZXJyO1xuICB9XG59O1xuXG5jb21tYW5kcy5sYXVuY2hBcHAgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5zdGFydCgpO1xuICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgbGF1bmNoZWQgdGhlIFske3RoaXMub3B0cy5hcHB9XSBhcHAuYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBTb21ldGhpbmcgd2VudCB3cm9uZyB3aGlsZSBsYXVuY2hpbmcgdGhlIFske3RoaXMub3B0cy5hcHB9XSBhcHAuYCk7XG4gICAgdGhyb3cgZXJyO1xuICB9XG59O1xuXG5jb21tYW5kcy5yZW1vdmVBcHAgPSBhc3luYyBmdW5jdGlvbiAoYnVuZGxlSWQpIHtcbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBhd2FpdCB0aGlzLnJlYWxEZXZpY2UucmVtb3ZlKGJ1bmRsZUlkKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCB0aGlzLnNpbS5yZW1vdmVBcHAoYnVuZGxlSWQpO1xuICB9XG59O1xuXG5jb21tYW5kcy5rZXlzID0gYXN5bmMgZnVuY3Rpb24gKGtleXMpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBsZXQgZWwgPSBhd2FpdCB0aGlzLmFjdGl2ZSgpO1xuICAgIGlmIChfLmlzVW5kZWZpbmVkKGVsLkVMRU1FTlQpKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLnNldFZhbHVlKGtleXMsIGVsLkVMRU1FTlQpO1xuICB9IGVsc2Uge1xuICAgIGlmIChfLmlzQXJyYXkoa2V5cykpIHtcbiAgICAgIGtleXMgPSBrZXlzLmpvaW4oJycpO1xuICAgIH1cbiAgICBpZiAoIV8uaXNTdHJpbmcoa2V5cykpIHtcbiAgICAgIGtleXMgPSBrZXlzLnRvU3RyaW5nKCk7XG4gICAgfVxuICAgIGtleXMgPSB1dGlsLmVzY2FwZVNwZWNpYWxDaGFycyhrZXlzLCBcIidcIik7XG4gICAgbGV0IGNvbW1hbmQgPSBgYXUuc2VuZEtleXNUb0FjdGl2ZUVsZW1lbnQoJyR7a2V5c30nKWA7XG4gICAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY29tbWFuZCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnNldEdlb0xvY2F0aW9uID0gYXN5bmMgZnVuY3Rpb24gKGxvY2F0aW9uKSB7XG4gIC8vIFRPRE86IGNoZWNrIHRoZSBoYXNPcHRpb25zIGJpdCwgdGhlIG1ldGhvZCBzaWduYXR1cmUgc2hvdWxkIGJlIGxvY2F0aW9uLCBvcHRpb25cblxuICAvL2xldCBoYXNPcHRpb25zID0gYWx0aXR1ZGUgIT09IG51bGwgfHwgaG9yaXpvbnRhbEFjY3VyYWN5ICE9PSBudWxsIHx8IHZlcnRpY2FsQWNjdXJhY3kgIT09IG51bGwgfHwgY291cnNlICE9PSBudWxsIHx8IHNwZWVkICE9PSBudWxsO1xuICAvL2lmIChoYXNPcHRpb25zKSB7XG4gICAgLy9sZXQgb3B0aW9ucyA9IHt9O1xuICAgIC8vaWYgKGFsdGl0dWRlICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMuYWx0aXR1ZGUgPSBhbHRpdHVkZTtcbiAgICAvL31cbiAgICAvL2lmIChob3Jpem9udGFsQWNjdXJhY3kgIT09IG51bGwpIHtcbiAgICAgIC8vb3B0aW9ucy5ob3Jpem9udGFsQWNjdXJhY3kgPSBob3Jpem9udGFsQWNjdXJhY3k7XG4gICAgLy99XG4gICAgLy9pZiAodmVydGljYWxBY2N1cmFjeSAhPT0gbnVsbCkge1xuICAgICAgLy9vcHRpb25zLnZlcnRpY2FsQWNjdXJhY3kgPSB2ZXJ0aWNhbEFjY3VyYWN5O1xuICAgIC8vfVxuICAgIC8vaWYgKGNvdXJzZSAhPT0gbnVsbCkge1xuICAgICAgLy9vcHRpb25zLmNvdXJzZSA9IGNvdXJzZTtcbiAgICAvL31cbiAgICAvL2lmIChzcGVlZCAhPT0gbnVsbCkge1xuICAgICAgLy9vcHRpb25zLnNwZWVkID0gc3BlZWQ7XG4gICAgLy99XG4gICAgLy9hd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcbiAgICAgIC8vYHRhcmdldC5zZXRMb2NhdGlvbldpdGhPcHRpb25zKCR7SlNPTi5zdHJpbmdpZnkoY29vcmRpbmF0ZXMpfSwgJHtKU09OLnN0cmluZ2lmeShvcHRpb25zKX0pYCk7XG4gIC8vfSBlbHNlIHtcbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoYHRhcmdldC5zZXRMb2NhdGlvbigke0pTT04uc3RyaW5naWZ5KGxvY2F0aW9uKX0pYCk7XG4gIC8vfVxufTtcblxuY29tbWFuZHMuZ2V0V2luZG93U2l6ZSA9IGFzeW5jIGZ1bmN0aW9uICh3aW5kb3dIYW5kbGU9XCJjdXJyZW50XCIpIHtcbiAgaWYgKHdpbmRvd0hhbmRsZSAhPT0gXCJjdXJyZW50XCIpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoXCJDdXJyZW50bHkgb25seSBnZXR0aW5nIGN1cnJlbnQgd2luZG93IHNpemUgaXMgc3VwcG9ydGVkLlwiKTtcbiAgfVxuXG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF93aW5kb3dfc2l6ZScsIFtdKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoXCJhdS5nZXRXaW5kb3dTaXplKClcIik7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldFN0cmluZ3MgPSBhc3luYyBmdW5jdGlvbiAobGFuZ3VhZ2UsIHN0cmluZ0ZpbGUgPSBudWxsKSB7XG4gIGxvZy5kZWJ1ZyhgR2V0dGluZ3Mgc3RyaW5ncyBmb3IgbGFuZ3VhZ2UgJyR7bGFuZ3VhZ2V9JyBhbmQgc3RyaW5nIGZpbGUgJyR7c3RyaW5nRmlsZX0nYCk7XG4gIGxldCBzdHJpbmdzID0gYXdhaXQgdXRpbHMucGFyc2VMb2NhbGl6YWJsZVN0cmluZ3MoXy5kZWZhdWx0cyh7bGFuZ3VhZ2UsIHN0cmluZ0ZpbGV9LCB0aGlzLm9wdHMpKTtcbiAgaWYgKHN0cmluZ3MgJiYgc3RyaW5ncy5sZW5ndGggPj0gMSkge1xuICAgIHN0cmluZ3MgPSBzdHJpbmdzWzBdO1xuICB9XG4gIHJldHVybiBzdHJpbmdzO1xufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl19