'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _teen_process = require('teen_process');

var _asyncbox = require('asyncbox');

var _appiumXcode = require('appium-xcode');

var _nodeSimctl = require('node-simctl');

var _appiumSupport = require('appium-support');

var OSASCRIPT_TIMEOUT = 10000;

function killAllSimulators() {
  var timeout = arguments.length <= 0 || arguments[0] === undefined ? OSASCRIPT_TIMEOUT : arguments[0];

  var appName, xcodeVersion, errString, remainingDevices, allSimsAreDown, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, device;

  return _regeneratorRuntime.async(function killAllSimulators$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        allSimsAreDown = function allSimsAreDown() {
          var devices;
          return _regeneratorRuntime.async(function allSimsAreDown$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                remainingDevices = [];
                context$2$0.next = 3;
                return _regeneratorRuntime.awrap((0, _nodeSimctl.getDevices)());

              case 3:
                devices = context$2$0.sent;

                devices = _lodash2['default'].flatten(_lodash2['default'].values(devices));
                return context$2$0.abrupt('return', _lodash2['default'].every(devices, function (sim) {
                  var state = sim.state.toLowerCase();
                  var done = state === 'shutdown' || state === 'unavailable' || state === 'disconnected';
                  if (!done) {
                    remainingDevices.push('Simulator not shut down: ' + sim.name + ' (' + sim.sdk + ', udid: ' + (sim.udid + ') is still in state \'' + state + '\''));
                  }
                  return done;
                }));

              case 6:
              case 'end':
                return context$2$0.stop();
            }
          }, null, this);
        };

        _logger2['default'].debug('Killing all iOS Simulators');

        appName = undefined;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap((0, _appiumXcode.getVersion)(true));

      case 5:
        xcodeVersion = context$1$0.sent;

        if (xcodeVersion.major >= 7) {
          appName = 'Simulator';
        } else {
          appName = 'iOS Simulator';
        }

        context$1$0.prev = 7;
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('osascript', ['-e', 'quit app "' + appName + '"'], { timeout: timeout }));

      case 10:
        context$1$0.next = 26;
        break;

      case 12:
        context$1$0.prev = 12;
        context$1$0.t0 = context$1$0['catch'](7);
        errString = JSON.stringify(context$1$0.t0);

        if (!errString.match(/Application isn.t running/)) {
          context$1$0.next = 19;
          break;
        }

        // on some systems we get an error that the application is not running
        _logger2['default'].debug('Application is not running. Continuing');
        context$1$0.next = 26;
        break;

      case 19:
        if (!context$1$0.t0.message.match(/timed out/)) {
          context$1$0.next = 25;
          break;
        }

        // sometimes, especially in xcode 8, the sim hangs
        _logger2['default'].debug('Killing simulator timed out. Using killall signal');
        context$1$0.next = 23;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('killall', [appName]));

      case 23:
        context$1$0.next = 26;
        break;

      case 25:
        _logger2['default'].errorAndThrow(context$1$0.t0);

      case 26:
        remainingDevices = undefined;
        context$1$0.prev = 27;
        context$1$0.next = 30;
        return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(allSimsAreDown, {
          waitMs: 60 * 1000,
          intervalMs: 200
        }));

      case 30:
        context$1$0.next = 56;
        break;

      case 32:
        context$1$0.prev = 32;
        context$1$0.t1 = context$1$0['catch'](27);

        if (!(remainingDevices && remainingDevices.length !== 0)) {
          context$1$0.next = 55;
          break;
        }

        _logger2['default'].error('The following devices are not in the correct state:');
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 39;
        for (_iterator = _getIterator(remainingDevices); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          device = _step.value;

          _logger2['default'].error('    ' + device);
        }
        context$1$0.next = 47;
        break;

      case 43:
        context$1$0.prev = 43;
        context$1$0.t2 = context$1$0['catch'](39);
        _didIteratorError = true;
        _iteratorError = context$1$0.t2;

      case 47:
        context$1$0.prev = 47;
        context$1$0.prev = 48;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 50:
        context$1$0.prev = 50;

        if (!_didIteratorError) {
          context$1$0.next = 53;
          break;
        }

        throw _iteratorError;

      case 53:
        return context$1$0.finish(50);

      case 54:
        return context$1$0.finish(47);

      case 55:
        throw context$1$0.t1;

      case 56:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[7, 12], [27, 32], [39, 43, 47, 55], [48,, 50, 54]]);
}

function endAllSimulatorDaemons() {
  var _arr, _i, servicePattern, launchCtlCommand, stopCmd, removeCmd;

  return _regeneratorRuntime.async(function endAllSimulatorDaemons$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Ending all simulator daemons');
        _arr = ['com.apple.iphonesimulator', 'com.apple.CoreSimulator'];
        _i = 0;

      case 3:
        if (!(_i < _arr.length)) {
          context$1$0.next = 28;
          break;
        }

        servicePattern = _arr[_i];

        _logger2['default'].debug('Killing any other ' + servicePattern + ' daemons');
        launchCtlCommand = 'launchctl list | grep ' + servicePattern + ' | cut -f 3 | xargs -n 1 launchctl';
        context$1$0.prev = 7;
        stopCmd = launchCtlCommand + ' stop';
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('bash', ['-c', stopCmd]));

      case 11:
        context$1$0.next = 16;
        break;

      case 13:
        context$1$0.prev = 13;
        context$1$0.t0 = context$1$0['catch'](7);

        _logger2['default'].warn('Could not stop ' + servicePattern + ' daemons, carrying on anyway!');

      case 16:
        context$1$0.prev = 16;
        removeCmd = launchCtlCommand + ' remove';
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('bash', ['-c', removeCmd]));

      case 20:
        context$1$0.next = 25;
        break;

      case 22:
        context$1$0.prev = 22;
        context$1$0.t1 = context$1$0['catch'](16);

        _logger2['default'].warn('Could not remove ' + servicePattern + ' daemons, carrying on anyway!');

      case 25:
        _i++;
        context$1$0.next = 3;
        break;

      case 28:
        context$1$0.prev = 28;
        context$1$0.next = 31;
        return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(function callee$1$0() {
          var _ref, stdout;

          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap((0, _teen_process.exec)('bash', ['-c', 'ps -e  | grep launchd_sim | grep -v bash | grep -v grep | awk {\'print$1\'}']));

              case 2:
                _ref = context$2$0.sent;
                stdout = _ref.stdout;
                return context$2$0.abrupt('return', stdout.trim().length === 0);

              case 5:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        }, { waitMs: 5000, intervalMs: 500 }));

      case 31:
        context$1$0.next = 36;
        break;

      case 33:
        context$1$0.prev = 33;
        context$1$0.t2 = context$1$0['catch'](28);

        _logger2['default'].warn('Could not end all simulator daemons, carrying on!');

      case 36:
        _logger2['default'].debug('Finishing ending all simulator daemons');

      case 37:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[7, 13], [16, 22], [28, 33]]);
}

function simExists(udid) {
  var devices;
  return _regeneratorRuntime.async(function simExists$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.getDevices)());

      case 2:
        devices = context$1$0.sent;

        devices = _lodash2['default'].toPairs(devices).map(function (pair) {
          return pair[1];
        }).reduce(function (a, b) {
          return a.concat(b);
        }, []);
        return context$1$0.abrupt('return', !!_lodash2['default'].find(devices, function (sim) {
          return sim.udid === udid;
        }));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function safeRimRaf(delPath) {
  var tryNum = arguments.length <= 1 || arguments[1] === undefined ? 0 : arguments[1];
  return _regeneratorRuntime.async(function safeRimRaf$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(delPath));

      case 3:
        context$1$0.next = 16;
        break;

      case 5:
        context$1$0.prev = 5;
        context$1$0.t0 = context$1$0['catch'](0);

        if (!(tryNum < 20)) {
          context$1$0.next = 16;
          break;
        }

        if (!(context$1$0.t0.message.indexOf('ENOTEMPTY') !== -1)) {
          context$1$0.next = 13;
          break;
        }

        _logger2['default'].debug('Path \'' + delPath + '\' was not empty during delete; retrying');
        return context$1$0.abrupt('return', safeRimRaf(delPath, tryNum + 1));

      case 13:
        if (!(context$1$0.t0.message.indexOf('ENOENT') !== -1)) {
          context$1$0.next = 16;
          break;
        }

        _logger2['default'].debug('Path \'' + delPath + '\'\' did not exist when we tried to delete, ignoring');
        return context$1$0.abrupt('return', safeRimRaf(delPath, tryNum + 1));

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 5]]);
}

exports.killAllSimulators = killAllSimulators;
exports.endAllSimulatorDaemons = endAllSimulatorDaemons;
exports.safeRimRaf = safeRimRaf;
exports.simExists = simExists;

// wait for all the devices to be shutdown before Continuing
// but only print out the failed ones when they are actually fully failed

// waiting until the simulator service has died.

// see the README for github.com/appium/node-simctl for example output of getDevices()
//# sourceMappingURL=data:application/json;charset=utf8;base64,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LElBQUksRUFBSztBQUN6QyxpQkFBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDaEIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFDLENBQUMsRUFBRSxDQUFDLEVBQUs7QUFDbEIsaUJBQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNwQixFQUFFLEVBQUUsQ0FBQyxDQUFDOzRDQUNBLENBQUMsQ0FBQyxvQkFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLFVBQUMsR0FBRyxFQUFLO0FBQ2hDLGlCQUFPLEdBQUcsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDO1NBQzFCLENBQUM7Ozs7Ozs7Q0FDSDs7QUFFRCxTQUFlLFVBQVUsQ0FBRSxPQUFPO01BQUUsTUFBTSx5REFBRyxDQUFDOzs7Ozs7eUNBRXBDLGtCQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUM7Ozs7Ozs7Ozs7Y0FFcEIsTUFBTSxHQUFHLEVBQUUsQ0FBQTs7Ozs7Y0FDVCxlQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7Ozs7O0FBQ3pDLDRCQUFJLEtBQUssYUFBVSxPQUFPLDhDQUEwQyxDQUFDOzRDQUM5RCxVQUFVLENBQUMsT0FBTyxFQUFFLE1BQU0sR0FBRyxDQUFDLENBQUM7OztjQUM3QixlQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7Ozs7O0FBQzdDLDRCQUFJLEtBQUssYUFBVSxPQUFPLDBEQUFxRCxDQUFDOzRDQUN6RSxVQUFVLENBQUMsT0FBTyxFQUFFLE1BQU0sR0FBRyxDQUFDLENBQUM7Ozs7Ozs7Q0FJN0M7O1FBRVEsaUJBQWlCLEdBQWpCLGlCQUFpQjtRQUFFLHNCQUFzQixHQUF0QixzQkFBc0I7UUFBRSxVQUFVLEdBQVYsVUFBVTtRQUFFLFNBQVMsR0FBVCxTQUFTIiwiZmlsZSI6ImxpYi91dGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGdldFZlcnNpb24gfSBmcm9tICdhcHBpdW0teGNvZGUnO1xuaW1wb3J0IHsgZ2V0RGV2aWNlcyB9IGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuXG5cbmNvbnN0IE9TQVNDUklQVF9USU1FT1VUID0gMTAwMDA7XG5cbmFzeW5jIGZ1bmN0aW9uIGtpbGxBbGxTaW11bGF0b3JzICh0aW1lb3V0ID0gT1NBU0NSSVBUX1RJTUVPVVQpIHtcbiAgbG9nLmRlYnVnKCdLaWxsaW5nIGFsbCBpT1MgU2ltdWxhdG9ycycpO1xuXG4gIGxldCBhcHBOYW1lO1xuICBsZXQgeGNvZGVWZXJzaW9uID0gYXdhaXQgZ2V0VmVyc2lvbih0cnVlKTtcbiAgaWYgKHhjb2RlVmVyc2lvbi5tYWpvciA+PSA3KSB7XG4gICAgYXBwTmFtZSA9ICdTaW11bGF0b3InO1xuICB9IGVsc2Uge1xuICAgIGFwcE5hbWUgPSAnaU9TIFNpbXVsYXRvcic7XG4gIH1cblxuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoJ29zYXNjcmlwdCcsIFsnLWUnLCBgcXVpdCBhcHAgXCIke2FwcE5hbWV9XCJgXSwge3RpbWVvdXR9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxldCBlcnJTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShlKTtcbiAgICBpZiAoZXJyU3RyaW5nLm1hdGNoKC9BcHBsaWNhdGlvbiBpc24udCBydW5uaW5nLykpIHtcbiAgICAgIC8vIG9uIHNvbWUgc3lzdGVtcyB3ZSBnZXQgYW4gZXJyb3IgdGhhdCB0aGUgYXBwbGljYXRpb24gaXMgbm90IHJ1bm5pbmdcbiAgICAgIGxvZy5kZWJ1ZygnQXBwbGljYXRpb24gaXMgbm90IHJ1bm5pbmcuIENvbnRpbnVpbmcnKTtcbiAgICB9IGVsc2UgaWYgKGUubWVzc2FnZS5tYXRjaCgvdGltZWQgb3V0LykpIHtcbiAgICAgIC8vIHNvbWV0aW1lcywgZXNwZWNpYWxseSBpbiB4Y29kZSA4LCB0aGUgc2ltIGhhbmdzXG4gICAgICBsb2cuZGVidWcoJ0tpbGxpbmcgc2ltdWxhdG9yIHRpbWVkIG91dC4gVXNpbmcga2lsbGFsbCBzaWduYWwnKTtcbiAgICAgIGF3YWl0IGV4ZWMoJ2tpbGxhbGwnLCBbYXBwTmFtZV0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhlKTtcbiAgICB9XG4gIH1cblxuICAvLyB3YWl0IGZvciBhbGwgdGhlIGRldmljZXMgdG8gYmUgc2h1dGRvd24gYmVmb3JlIENvbnRpbnVpbmdcbiAgLy8gYnV0IG9ubHkgcHJpbnQgb3V0IHRoZSBmYWlsZWQgb25lcyB3aGVuIHRoZXkgYXJlIGFjdHVhbGx5IGZ1bGx5IGZhaWxlZFxuICBsZXQgcmVtYWluaW5nRGV2aWNlcztcbiAgYXN5bmMgZnVuY3Rpb24gYWxsU2ltc0FyZURvd24gKCkge1xuICAgIHJlbWFpbmluZ0RldmljZXMgPSBbXTtcbiAgICBsZXQgZGV2aWNlcyA9IGF3YWl0IGdldERldmljZXMoKTtcbiAgICBkZXZpY2VzID0gXy5mbGF0dGVuKF8udmFsdWVzKGRldmljZXMpKTtcbiAgICByZXR1cm4gXy5ldmVyeShkZXZpY2VzLCAoc2ltKSA9PiB7XG4gICAgICBsZXQgc3RhdGUgPSBzaW0uc3RhdGUudG9Mb3dlckNhc2UoKTtcbiAgICAgIGxldCBkb25lID0gc3RhdGUgPT09ICdzaHV0ZG93bicgfHxcbiAgICAgICAgICAgICAgICAgc3RhdGUgPT09ICd1bmF2YWlsYWJsZScgfHxcbiAgICAgICAgICAgICAgICAgc3RhdGUgPT09ICdkaXNjb25uZWN0ZWQnO1xuICAgICAgaWYgKCFkb25lKSB7XG4gICAgICAgIHJlbWFpbmluZ0RldmljZXMucHVzaChgU2ltdWxhdG9yIG5vdCBzaHV0IGRvd246ICR7c2ltLm5hbWV9ICgke3NpbS5zZGt9LCB1ZGlkOiBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke3NpbS51ZGlkfSkgaXMgc3RpbGwgaW4gc3RhdGUgJyR7c3RhdGV9J2ApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGRvbmU7XG4gICAgfSk7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFsbFNpbXNBcmVEb3duLCB7XG4gICAgICB3YWl0TXM6IDYwICogMTAwMCxcbiAgICAgIGludGVydmFsTXM6IDIwMFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAocmVtYWluaW5nRGV2aWNlcyAmJiByZW1haW5pbmdEZXZpY2VzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgbG9nLmVycm9yKCdUaGUgZm9sbG93aW5nIGRldmljZXMgYXJlIG5vdCBpbiB0aGUgY29ycmVjdCBzdGF0ZTonKTtcbiAgICAgIGZvciAobGV0IGRldmljZSBvZiByZW1haW5pbmdEZXZpY2VzKSB7XG4gICAgICAgIGxvZy5lcnJvcihgICAgICR7ZGV2aWNlfWApO1xuICAgICAgfVxuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZW5kQWxsU2ltdWxhdG9yRGFlbW9ucyAoKSB7XG4gIGxvZy5kZWJ1ZygnRW5kaW5nIGFsbCBzaW11bGF0b3IgZGFlbW9ucycpO1xuICBmb3IgKGxldCBzZXJ2aWNlUGF0dGVybiBvZiBbJ2NvbS5hcHBsZS5pcGhvbmVzaW11bGF0b3InLCAnY29tLmFwcGxlLkNvcmVTaW11bGF0b3InXSkge1xuICAgIGxvZy5kZWJ1ZyhgS2lsbGluZyBhbnkgb3RoZXIgJHtzZXJ2aWNlUGF0dGVybn0gZGFlbW9uc2ApO1xuICAgIGxldCBsYXVuY2hDdGxDb21tYW5kID0gYGxhdW5jaGN0bCBsaXN0IHwgZ3JlcCAke3NlcnZpY2VQYXR0ZXJufSB8IGN1dCAtZiAzIHwgeGFyZ3MgLW4gMSBsYXVuY2hjdGxgO1xuICAgIHRyeSB7XG4gICAgICBsZXQgc3RvcENtZCA9IGAke2xhdW5jaEN0bENvbW1hbmR9IHN0b3BgO1xuICAgICAgYXdhaXQgZXhlYygnYmFzaCcsIFsnLWMnLCBzdG9wQ21kXSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgQ291bGQgbm90IHN0b3AgJHtzZXJ2aWNlUGF0dGVybn0gZGFlbW9ucywgY2Fycnlpbmcgb24gYW55d2F5IWApO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgbGV0IHJlbW92ZUNtZCA9IGAke2xhdW5jaEN0bENvbW1hbmR9IHJlbW92ZWA7XG4gICAgICBhd2FpdCBleGVjKCdiYXNoJywgWyctYycsIHJlbW92ZUNtZF0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYENvdWxkIG5vdCByZW1vdmUgJHtzZXJ2aWNlUGF0dGVybn0gZGFlbW9ucywgY2Fycnlpbmcgb24gYW55d2F5IWApO1xuICAgIH1cbiAgfVxuICAvLyB3YWl0aW5nIHVudGlsIHRoZSBzaW11bGF0b3Igc2VydmljZSBoYXMgZGllZC5cbiAgdHJ5IHtcbiAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ2Jhc2gnLCBbJy1jJyxcbiAgICAgICAgYHBzIC1lICB8IGdyZXAgbGF1bmNoZF9zaW0gfCBncmVwIC12IGJhc2ggfCBncmVwIC12IGdyZXAgfCBhd2sgeydwcmludCQxJ31gXSk7XG4gICAgICByZXR1cm4gc3Rkb3V0LnRyaW0oKS5sZW5ndGggPT09IDA7XG4gICAgfSwge3dhaXRNczogNTAwMCwgaW50ZXJ2YWxNczogNTAwfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDb3VsZCBub3QgZW5kIGFsbCBzaW11bGF0b3IgZGFlbW9ucywgY2Fycnlpbmcgb24hYCk7XG4gIH1cbiAgbG9nLmRlYnVnKCdGaW5pc2hpbmcgZW5kaW5nIGFsbCBzaW11bGF0b3IgZGFlbW9ucycpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzaW1FeGlzdHMgKHVkaWQpIHtcbiAgLy8gc2VlIHRoZSBSRUFETUUgZm9yIGdpdGh1Yi5jb20vYXBwaXVtL25vZGUtc2ltY3RsIGZvciBleGFtcGxlIG91dHB1dCBvZiBnZXREZXZpY2VzKClcbiAgbGV0IGRldmljZXMgPSBhd2FpdCBnZXREZXZpY2VzKCk7XG5cbiAgZGV2aWNlcyA9IF8udG9QYWlycyhkZXZpY2VzKS5tYXAoKHBhaXIpID0+IHtcbiAgICByZXR1cm4gcGFpclsxXTtcbiAgfSkucmVkdWNlKChhLCBiKSA9PiB7XG4gICAgcmV0dXJuIGEuY29uY2F0KGIpO1xuICB9LCBbXSk7XG4gIHJldHVybiAhIV8uZmluZChkZXZpY2VzLCAoc2ltKSA9PiB7XG4gICAgcmV0dXJuIHNpbS51ZGlkID09PSB1ZGlkO1xuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2FmZVJpbVJhZiAoZGVsUGF0aCwgdHJ5TnVtID0gMCkge1xuICB0cnkge1xuICAgIGF3YWl0IGZzLnJpbXJhZihkZWxQYXRoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKHRyeU51bSA8IDIwKSB7XG4gICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZignRU5PVEVNUFRZJykgIT09IC0xKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgUGF0aCAnJHtkZWxQYXRofScgd2FzIG5vdCBlbXB0eSBkdXJpbmcgZGVsZXRlOyByZXRyeWluZ2ApO1xuICAgICAgICByZXR1cm4gc2FmZVJpbVJhZihkZWxQYXRoLCB0cnlOdW0gKyAxKTtcbiAgICAgIH0gZWxzZSBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZignRU5PRU5UJykgIT09IC0xKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgUGF0aCAnJHtkZWxQYXRofScnIGRpZCBub3QgZXhpc3Qgd2hlbiB3ZSB0cmllZCB0byBkZWxldGUsIGlnbm9yaW5nYCk7XG4gICAgICAgIHJldHVybiBzYWZlUmltUmFmKGRlbFBhdGgsIHRyeU51bSArIDEpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBraWxsQWxsU2ltdWxhdG9ycywgZW5kQWxsU2ltdWxhdG9yRGFlbW9ucywgc2FmZVJpbVJhZiwgc2ltRXhpc3RzIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
