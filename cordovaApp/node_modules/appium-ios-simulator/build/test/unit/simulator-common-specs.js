require('source-map-support').install();

'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Promise = require('babel-runtime/core-js/promise')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _libSimulatorXcode6 = require('../../lib/simulator-xcode-6');

var _libSimulatorXcode62 = _interopRequireDefault(_libSimulatorXcode6);

var _libSimulatorXcode7 = require('../../lib/simulator-xcode-7');

var _libSimulatorXcode72 = _interopRequireDefault(_libSimulatorXcode7);

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _appiumSupport = require('appium-support');

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

var simulatorClasses = {
  SimulatorXcode6: _libSimulatorXcode62['default'],
  SimulatorXcode7: _libSimulatorXcode72['default']
};

var _iteratorNormalCompletion = true;
var _didIteratorError = false;
var _iteratorError = undefined;

try {
  var _loop = function () {
    var _step$value = _slicedToArray(_step.value, 2);

    var name = _step$value[0];
    var simClass = _step$value[1];

    describe('common methods - ' + name, function () {
      var sim = undefined;
      beforeEach(function () {
        sim = new simClass('123', '6.0.0');
      });

      it('should exist', function () {
        simClass.should.exist;
      });

      it('should return a path for getDir()', function () {
        sim.getDir().should.exist;
      });

      it('should return an array for getAppDirs()', function callee$2$0() {
        var dirs;
        return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
          while (1) switch (context$3$0.prev = context$3$0.next) {
            case 0:
              _sinon2['default'].stub(sim, 'getAppDir').returns(_Promise.resolve(['/App/Path/']));
              sim._platformVersion = 9.1;
              context$3$0.next = 4;
              return _regeneratorRuntime.awrap(sim.getAppDirs('test'));

            case 4:
              dirs = context$3$0.sent;

              dirs.should.have.length(2);
              dirs.should.be.a('array');
              _sinon2['default'].restore();

            case 8:
            case 'end':
              return context$3$0.stop();
          }
        }, null, _this);
      });

      describe('cleanCustomApp', function () {
        var sandbox = undefined;
        var appBundleId = 'com.some.app';
        beforeEach(function () {
          sandbox = _sinon2['default'].sandbox.create();
          sandbox.spy(_appiumSupport.fs, 'rimraf');
        });
        afterEach(function () {
          sandbox.restore();
        });
        it('should not delete anything if no directories are found', function callee$3$0() {
          return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
            while (1) switch (context$4$0.prev = context$4$0.next) {
              case 0:
                sandbox.stub(sim, 'getPlatformVersion').returns(_Promise.resolve(7.1));
                sandbox.stub(sim, 'getAppDir').returns(_Promise.resolve());
                context$4$0.next = 4;
                return _regeneratorRuntime.awrap(sim.cleanCustomApp('someApp', 'com.some.app'));

              case 4:
                _sinon2['default'].assert.notCalled(_appiumSupport.fs.rimraf);

              case 5:
              case 'end':
                return context$4$0.stop();
            }
          }, null, _this);
        });
        it('should delete app directories', function callee$3$0() {
          return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
            while (1) switch (context$4$0.prev = context$4$0.next) {
              case 0:
                sandbox.stub(sim, 'getPlatformVersion').returns(_Promise.resolve(7.1));
                sandbox.stub(sim, 'getAppDirs').returns(_Promise.resolve(['/some/path', '/another/path']));
                context$4$0.next = 4;
                return _regeneratorRuntime.awrap(sim.cleanCustomApp('someApp', 'com.some.app'));

              case 4:
                _sinon2['default'].assert.called(_appiumSupport.fs.rimraf);

              case 5:
              case 'end':
                return context$4$0.stop();
            }
          }, null, _this);
        });
        it('should delete plist file for iOS8+', function callee$3$0() {
          return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
            while (1) switch (context$4$0.prev = context$4$0.next) {
              case 0:
                sandbox.stub(sim, 'getPlatformVersion').returns(_Promise.resolve(9));
                sandbox.stub(sim, 'getAppDirs').returns(_Promise.resolve(['/some/path', '/another/path']));
                context$4$0.next = 4;
                return _regeneratorRuntime.awrap(sim.cleanCustomApp('someApp', appBundleId));

              case 4:
                _sinon2['default'].assert.calledWithMatch(_appiumSupport.fs.rimraf, /plist/);

              case 5:
              case 'end':
                return context$4$0.stop();
            }
          }, null, _this);
        });
        it('should not delete plist file for iOS7.1', function callee$3$0() {
          return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
            while (1) switch (context$4$0.prev = context$4$0.next) {
              case 0:
                sandbox.stub(sim, 'getPlatformVersion').returns(_Promise.resolve(7.1));
                sandbox.stub(sim, 'getAppDirs').returns(_Promise.resolve(['/some/path', '/another/path']));
                context$4$0.next = 4;
                return _regeneratorRuntime.awrap(sim.cleanCustomApp('someApp', appBundleId));

              case 4:
                _sinon2['default'].assert.neverCalledWithMatch(_appiumSupport.fs.rimraf, /plist/);

              case 5:
              case 'end':
                return context$4$0.stop();
            }
          }, null, _this);
        });
      });

      it('should return a path for getLogDir', function () {
        var home = process.env.HOME;
        process.env.HOME = __dirname;
        var logDir = sim.getLogDir();
        logDir.should.equal(__dirname + '/Library/Logs/CoreSimulator/123');
        process.env.HOME = home;
      });

      describe('getPlatformVersion', function () {
        var statStub = undefined;
        var platformVersion = 8.9;
        beforeEach(function () {
          statStub = _sinon2['default'].stub(sim, 'stat').returns({ sdk: platformVersion });
        });
        afterEach(function () {
          statStub.restore();
        });
        it('should get the correct platform version', function callee$3$0() {
          var pv;
          return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
            while (1) switch (context$4$0.prev = context$4$0.next) {
              case 0:
                context$4$0.next = 2;
                return _regeneratorRuntime.awrap(sim.getPlatformVersion());

              case 2:
                pv = context$4$0.sent;

                pv.should.equal(platformVersion);

              case 4:
              case 'end':
                return context$4$0.stop();
            }
          }, null, _this);
        });
        it('should only call stat once', function callee$3$0() {
          var pv;
          return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
            while (1) switch (context$4$0.prev = context$4$0.next) {
              case 0:
                context$4$0.next = 2;
                return _regeneratorRuntime.awrap(sim.getPlatformVersion());

              case 2:
                pv = context$4$0.sent;

                pv.should.equal(platformVersion);
                statStub.calledOnce.should.be['true'];

              case 5:
              case 'end':
                return context$4$0.stop();
            }
          }, null, _this);
        });
      });
    });
  };

  for (var _iterator = _getIterator(_lodash2['default'].toPairs(simulatorClasses)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
    _loop();
  }
} catch (err) {
  _didIteratorError = true;
  _iteratorError = err;
} finally {
  try {
    if (!_iteratorNormalCompletion && _iterator['return']) {
      _iterator['return']();
    }
  } finally {
    if (_didIteratorError) {
      throw _iteratorError;
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9zaW11bGF0b3ItY29tbW9uLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7a0NBRTRCLDZCQUE2Qjs7OztrQ0FDN0IsNkJBQTZCOzs7O29CQUN4QyxNQUFNOzs7OzhCQUNJLGtCQUFrQjs7OztzQkFDL0IsUUFBUTs7OztxQkFDSixPQUFPOzs7OzZCQUNOLGdCQUFnQjs7QUFFbkMsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDZCxrQkFBSyxHQUFHLDZCQUFnQixDQUFDOztBQUV6QixJQUFJLGdCQUFnQixHQUFHO0FBQ3JCLGlCQUFlLGlDQUFBO0FBQ2YsaUJBQWUsaUNBQUE7Q0FDaEIsQ0FBQzs7Ozs7Ozs7OztRQUVRLElBQUk7UUFBRSxRQUFROztBQUN0QixZQUFRLHVCQUFxQixJQUFJLEVBQUksWUFBTTtBQUN6QyxVQUFJLEdBQUcsWUFBQSxDQUFDO0FBQ1IsZ0JBQVUsQ0FBQyxZQUFNO0FBQ2YsV0FBRyxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztPQUNwQyxDQUFDLENBQUM7O0FBRUgsUUFBRSxDQUFDLGNBQWMsRUFBRSxZQUFNO0FBQ3ZCLGdCQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztPQUN2QixDQUFDLENBQUM7O0FBRUgsUUFBRSxDQUFDLG1DQUFtQyxFQUFFLFlBQU07QUFDNUMsV0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7T0FDM0IsQ0FBQyxDQUFDOztBQUVILFFBQUUsQ0FBQyx5Q0FBeUMsRUFBRTtZQUd4QyxJQUFJOzs7O0FBRlIsaUNBQU0sSUFBSSxDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUSxPQUFPLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEUsaUJBQUcsQ0FBQyxnQkFBZ0IsR0FBRyxHQUFHLENBQUM7OytDQUNWLEdBQUcsQ0FBQyxV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LENBQUM7Ozs7Ozs7U0FDbEMsQ0FBQyxDQUFDO0FBQ0gsVUFBRSxDQUFDLDRCQUE0QixFQUFFO2NBQzNCLEVBQUU7Ozs7O2lEQUFTLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRTs7O0FBQW5DLGtCQUFFOztBQUNOLGtCQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUNqQyx3QkFBUSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxRQUFLLENBQUM7Ozs7Ozs7U0FDcEMsQ0FBQyxDQUFDO09BQ0osQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDOzs7QUF2Rkwsb0NBQTZCLG9CQUFFLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyw0R0FBRTs7R0F3RnpEIiwiZmlsZSI6InRlc3QvdW5pdC9zaW11bGF0b3ItY29tbW9uLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlOm1vY2hhXG5cbmltcG9ydCBTaW11bGF0b3JYY29kZTYgZnJvbSAnLi4vLi4vbGliL3NpbXVsYXRvci14Y29kZS02JztcbmltcG9ydCBTaW11bGF0b3JYY29kZTcgZnJvbSAnLi4vLi4vbGliL3NpbXVsYXRvci14Y29kZS03JztcbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBzaW5vbiBmcm9tICdzaW5vbic7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuY2hhaS5zaG91bGQoKTtcbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcblxubGV0IHNpbXVsYXRvckNsYXNzZXMgPSB7XG4gIFNpbXVsYXRvclhjb2RlNixcbiAgU2ltdWxhdG9yWGNvZGU3XG59O1xuXG5mb3IgKGxldCBbbmFtZSwgc2ltQ2xhc3NdIG9mIF8udG9QYWlycyhzaW11bGF0b3JDbGFzc2VzKSkge1xuICBkZXNjcmliZShgY29tbW9uIG1ldGhvZHMgLSAke25hbWV9YCwgKCkgPT4ge1xuICAgIGxldCBzaW07XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBzaW0gPSBuZXcgc2ltQ2xhc3MoJzEyMycsICc2LjAuMCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBleGlzdCcsICgpID0+IHtcbiAgICAgIHNpbUNsYXNzLnNob3VsZC5leGlzdDtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGEgcGF0aCBmb3IgZ2V0RGlyKCknLCAoKSA9PiB7XG4gICAgICBzaW0uZ2V0RGlyKCkuc2hvdWxkLmV4aXN0O1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gYW4gYXJyYXkgZm9yIGdldEFwcERpcnMoKScsIGFzeW5jICgpID0+IHtcbiAgICAgIHNpbm9uLnN0dWIoc2ltLCAnZ2V0QXBwRGlyJykucmV0dXJucyhQcm9taXNlLnJlc29sdmUoWycvQXBwL1BhdGgvJ10pKTtcbiAgICAgIHNpbS5fcGxhdGZvcm1WZXJzaW9uID0gOS4xO1xuICAgICAgbGV0IGRpcnMgPSBhd2FpdCBzaW0uZ2V0QXBwRGlycygndGVzdCcpO1xuICAgICAgZGlycy5zaG91bGQuaGF2ZS5sZW5ndGgoMik7XG4gICAgICBkaXJzLnNob3VsZC5iZS5hKCdhcnJheScpO1xuICAgICAgc2lub24ucmVzdG9yZSgpO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2NsZWFuQ3VzdG9tQXBwJywgKCkgPT4ge1xuICAgICAgbGV0IHNhbmRib3g7XG4gICAgICBsZXQgYXBwQnVuZGxlSWQgPSAnY29tLnNvbWUuYXBwJztcbiAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICBzYW5kYm94ID0gc2lub24uc2FuZGJveC5jcmVhdGUoKTtcbiAgICAgICAgc2FuZGJveC5zcHkoZnMsICdyaW1yYWYnKTtcbiAgICAgIH0pO1xuICAgICAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICAgICAgc2FuZGJveC5yZXN0b3JlKCk7XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgbm90IGRlbGV0ZSBhbnl0aGluZyBpZiBubyBkaXJlY3RvcmllcyBhcmUgZm91bmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIHNhbmRib3guc3R1YihzaW0sICdnZXRQbGF0Zm9ybVZlcnNpb24nKS5yZXR1cm5zKFByb21pc2UucmVzb2x2ZSg3LjEpKTtcbiAgICAgICAgc2FuZGJveC5zdHViKHNpbSwgJ2dldEFwcERpcicpLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKCkpO1xuICAgICAgICBhd2FpdCBzaW0uY2xlYW5DdXN0b21BcHAoJ3NvbWVBcHAnLCAnY29tLnNvbWUuYXBwJyk7XG4gICAgICAgIHNpbm9uLmFzc2VydC5ub3RDYWxsZWQoZnMucmltcmFmKTtcbiAgICAgIH0pO1xuICAgICAgaXQoJ3Nob3VsZCBkZWxldGUgYXBwIGRpcmVjdG9yaWVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBzYW5kYm94LnN0dWIoc2ltLCAnZ2V0UGxhdGZvcm1WZXJzaW9uJykucmV0dXJucyhQcm9taXNlLnJlc29sdmUoNy4xKSk7XG4gICAgICAgIHNhbmRib3guc3R1YihzaW0sICdnZXRBcHBEaXJzJykucmV0dXJucyhQcm9taXNlLnJlc29sdmUoWycvc29tZS9wYXRoJywgJy9hbm90aGVyL3BhdGgnXSkpO1xuICAgICAgICBhd2FpdCBzaW0uY2xlYW5DdXN0b21BcHAoJ3NvbWVBcHAnLCAnY29tLnNvbWUuYXBwJyk7XG4gICAgICAgIHNpbm9uLmFzc2VydC5jYWxsZWQoZnMucmltcmFmKTtcbiAgICAgIH0pO1xuICAgICAgaXQoJ3Nob3VsZCBkZWxldGUgcGxpc3QgZmlsZSBmb3IgaU9TOCsnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIHNhbmRib3guc3R1YihzaW0sICdnZXRQbGF0Zm9ybVZlcnNpb24nKS5yZXR1cm5zKFByb21pc2UucmVzb2x2ZSg5KSk7XG4gICAgICAgIHNhbmRib3guc3R1YihzaW0sICdnZXRBcHBEaXJzJykucmV0dXJucyhQcm9taXNlLnJlc29sdmUoWycvc29tZS9wYXRoJywgJy9hbm90aGVyL3BhdGgnXSkpO1xuICAgICAgICBhd2FpdCBzaW0uY2xlYW5DdXN0b21BcHAoJ3NvbWVBcHAnLCBhcHBCdW5kbGVJZCk7XG4gICAgICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoTWF0Y2goZnMucmltcmFmLCAvcGxpc3QvKTtcbiAgICAgIH0pO1xuICAgICAgaXQoJ3Nob3VsZCBub3QgZGVsZXRlIHBsaXN0IGZpbGUgZm9yIGlPUzcuMScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgc2FuZGJveC5zdHViKHNpbSwgJ2dldFBsYXRmb3JtVmVyc2lvbicpLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKDcuMSkpO1xuICAgICAgICBzYW5kYm94LnN0dWIoc2ltLCAnZ2V0QXBwRGlycycpLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKFsnL3NvbWUvcGF0aCcsICcvYW5vdGhlci9wYXRoJ10pKTtcbiAgICAgICAgYXdhaXQgc2ltLmNsZWFuQ3VzdG9tQXBwKCdzb21lQXBwJywgYXBwQnVuZGxlSWQpO1xuICAgICAgICBzaW5vbi5hc3NlcnQubmV2ZXJDYWxsZWRXaXRoTWF0Y2goZnMucmltcmFmLCAvcGxpc3QvKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gYSBwYXRoIGZvciBnZXRMb2dEaXInLCAoKSA9PiB7XG4gICAgICB2YXIgaG9tZSA9IHByb2Nlc3MuZW52LkhPTUU7XG4gICAgICBwcm9jZXNzLmVudi5IT01FID0gX19kaXJuYW1lO1xuICAgICAgbGV0IGxvZ0RpciA9IHNpbS5nZXRMb2dEaXIoKTtcbiAgICAgIGxvZ0Rpci5zaG91bGQuZXF1YWwoYCR7X19kaXJuYW1lfS9MaWJyYXJ5L0xvZ3MvQ29yZVNpbXVsYXRvci8xMjNgKTtcbiAgICAgIHByb2Nlc3MuZW52LkhPTUUgPSBob21lO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2dldFBsYXRmb3JtVmVyc2lvbicsICgpID0+IHtcbiAgICAgIGxldCBzdGF0U3R1YjtcbiAgICAgIGxldCBwbGF0Zm9ybVZlcnNpb24gPSA4Ljk7XG4gICAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgICAgc3RhdFN0dWIgPSBzaW5vbi5zdHViKHNpbSwgJ3N0YXQnKS5yZXR1cm5zKHtzZGs6IHBsYXRmb3JtVmVyc2lvbn0pO1xuICAgICAgfSk7XG4gICAgICBhZnRlckVhY2goKCkgPT4ge1xuICAgICAgICBzdGF0U3R1Yi5yZXN0b3JlKCk7XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgZ2V0IHRoZSBjb3JyZWN0IHBsYXRmb3JtIHZlcnNpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGxldCBwdiA9IGF3YWl0IHNpbS5nZXRQbGF0Zm9ybVZlcnNpb24oKTtcbiAgICAgICAgcHYuc2hvdWxkLmVxdWFsKHBsYXRmb3JtVmVyc2lvbik7XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgb25seSBjYWxsIHN0YXQgb25jZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgbGV0IHB2ID0gYXdhaXQgc2ltLmdldFBsYXRmb3JtVmVyc2lvbigpO1xuICAgICAgICBwdi5zaG91bGQuZXF1YWwocGxhdGZvcm1WZXJzaW9uKTtcbiAgICAgICAgc3RhdFN0dWIuY2FsbGVkT25jZS5zaG91bGQuYmUudHJ1ZTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn1cbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
