'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _appiumIosDriver = require('appium-ios-driver');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var helpers = {},
    extensions = {},
    commands = {};

commands.moveTo = _appiumIosDriver.iosCommands.gesture.moveTo;

commands.click = function callee$0$0(el) {
  var atomsElement;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.UnknownError('Command should be proxied to WDA');

      case 2:
        el = _appiumSupport.util.unwrapElement(el);

        if (!(this.opts.nativeWebTap && !this.isRealDevice())) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.nativeWebTap(el));

      case 6:
        context$1$0.next = 12;
        break;

      case 8:
        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.executeAtom('click', [atomsElement]));

      case 11:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.performTouch = function callee$0$0(gestures) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!isTap(gestures)) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.handleTap(gestures[0]));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
        if (!(gestures.length === 1 && (gestures[0] || '').action.toLowerCase() === 'doubletap')) {
          context$1$0.next = 12;
          break;
        }

        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.handleDoubleTap(gestures[0]));

      case 9:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 12:
        if (!isLongPress(gestures)) {
          context$1$0.next = 18;
          break;
        }

        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(this.handleLongPress(gestures));

      case 15:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 18:
        if (!isDrag(gestures)) {
          context$1$0.next = 24;
          break;
        }

        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(this.handleDrag(gestures));

      case 21:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 24:
        if (!isScroll(gestures)) {
          context$1$0.next = 28;
          break;
        }

        context$1$0.next = 27;
        return _regeneratorRuntime.awrap(this.handleScroll(gestures));

      case 27:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 28:
        throw new _appiumBaseDriver.errors.NotYetImplementedError('Support for gestures other than Tap is not yet implemented. Please contact an Appium dev');

      case 29:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.performMultiAction = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        throw new _appiumBaseDriver.errors.NotYetImplementedError('Support for multi-action API is not yet implemented. Please contact an Appium dev.');

      case 1:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.nativeClick = function callee$0$0(el) {
  var endpoint;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = _appiumSupport.util.unwrapElement(el);
        endpoint = '/element/' + el + '/click';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.proxyCommand(endpoint, 'POST', {}));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

function isDrag(gestures) {
  return gestures.length === 4 && gestures[0].action === 'press' && gestures[1].action === 'wait' && gestures[2].action === 'moveTo' && gestures[3].action === 'release';
}

function isTap(gestures) {
  if (gestures.length === 1 && gestures[0].action === 'tap') {
    return true;
  } else if (gestures.length === 2 && gestures[0].action === 'press' && gestures[1].action === 'release') {
    return true;
  }
  return false;
}

function isLongPress(gestures) {
  if (gestures.length === 1 && gestures[0].action.toLowerCase() === 'longpress') {
    return true;
  } else if (gestures.length === 3 && gestures[0].action === 'press' && gestures[1].action === 'wait' && gestures[2].action === 'release') {
    return true;
  }
  return false;
}

function isScroll(gestures) {
  if (gestures.length === 3 && gestures[0].action === 'press' && gestures[1].action === 'moveTo' && gestures[2].action === 'release') {
    return true;
  }
  return false;
}

helpers.handleScroll = function callee$0$0(gestures) {
  var dragGestures;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!gestures[1].options.element) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.mobileScroll({
          element: gestures[1].options.element,
          toVisible: true
        }));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 4:
        dragGestures = [gestures[0], { action: 'wait', options: { ms: 0 } }, gestures[1], gestures[2]];
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.handleDrag(dragGestures));

      case 7:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.handleDrag = function callee$0$0(gestures) {
  var press, wait, moveTo, pressCoordinates, duration, moveToCoordinates, params, endpoint;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        press = gestures[0];
        wait = gestures[1];
        moveTo = gestures[2];
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getCoordinates(press));

      case 5:
        pressCoordinates = context$1$0.sent;
        duration = parseInt(wait.options.ms, 10) / 1000;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getCoordinates(moveTo));

      case 9:
        moveToCoordinates = context$1$0.sent;

        // update moveTo coordinates with offset
        moveToCoordinates = this.applyMoveToOffset(pressCoordinates, moveToCoordinates);

        // build drag command
        params = {};

        params.fromX = pressCoordinates.x;
        params.fromY = pressCoordinates.y;
        params.toX = moveToCoordinates.x;
        params.toY = moveToCoordinates.y;
        params.duration = duration;

        endpoint = '/uiaTarget/0/dragfromtoforduration';
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(this.proxyCommand(endpoint, 'POST', params));

      case 20:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 21:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.handleTap = function callee$0$0(gesture) {
  var options, params, el, endpoint;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        options = gesture.options || {};
        params = {};

        if (_appiumSupport.util.hasValue(options.x) && _appiumSupport.util.hasValue(options.y)) {
          params.x = options.x;
          params.y = options.y;
        }

        el = _appiumSupport.util.hasValue(options.element) ? options.element : '';
        endpoint = '/tap/' + el;

        if (_appiumSupport.util.hasValue(this.opts.tapWithShortPressDuration)) {
          // in some cases `tap` is too slow, so allow configurable long press
          _logger2['default'].debug('Translating tap into long press with \'' + this.opts.tapWithShortPressDuration + '\' duration');
          params.duration = parseFloat(this.opts.tapWithShortPressDuration);
          endpoint = '/uiaElement/' + el + '/touchAndHold';
          params.duration = parseFloat(this.opts.tapWithShortPressDuration);
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.proxyCommand(endpoint, 'POST', params));

      case 8:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.handleDoubleTap = function callee$0$0(gesture) {
  var opts, el, endpoint;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        opts = gesture.options || {};

        if (opts.element) {
          context$1$0.next = 3;
          break;
        }

        throw new _appiumBaseDriver.errors.BadParametersError('WDA double tap needs an element');

      case 3:
        el = opts.element.ELEMENT ? opts.element.ELEMENT : opts.element;
        endpoint = '/uiaElement/' + el + '/doubleTap';
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.proxyCommand(endpoint, 'POST'));

      case 7:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.handleLongPress = function callee$0$0(gestures) {
  var pressOpts, el, duration, params, endpoint;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        pressOpts = gestures[0].options || {};
        el = _appiumSupport.util.unwrapElement(pressOpts.element);

        if (el) {
          context$1$0.next = 4;
          break;
        }

        throw new _appiumBaseDriver.errors.BadParametersError('WDA long press needs an element');

      case 4:
        duration = 0.8;

        if (gestures.length === 1 && _appiumSupport.util.hasValue(pressOpts.duration)) {
          duration = pressOpts.duration;
        } else if (gestures.length === 3) {
          // duration is the `wait` action
          // upstream system expects seconds not milliseconds
          duration = parseFloat(gestures[1].options.ms) / 1000;
        }

        params = {
          duration: duration
        };
        endpoint = '/uiaElement/' + el + '/touchAndHold';
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.proxyCommand(endpoint, 'POST', params));

      case 10:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.mobileScroll = function callee$0$0() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
  var params, msg, element, endpoint;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (opts.element) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.findElement('class name', 'XCUIElementTypeApplication'));

      case 3:
        opts.element = context$1$0.sent;

      case 4:
        params = {};

        if (!opts.name) {
          context$1$0.next = 9;
          break;
        }

        params.name = opts.name;
        context$1$0.next = 23;
        break;

      case 9:
        if (!opts.direction) {
          context$1$0.next = 13;
          break;
        }

        params.direction = opts.direction;
        context$1$0.next = 23;
        break;

      case 13:
        if (!opts.predicateString) {
          context$1$0.next = 17;
          break;
        }

        params.predicateString = opts.predicateString;
        context$1$0.next = 23;
        break;

      case 17:
        if (!opts.toVisible) {
          context$1$0.next = 21;
          break;
        }

        params.toVisible = opts.toVisible;
        context$1$0.next = 23;
        break;

      case 21:
        msg = 'Mobile scroll supports the following strategies: name, ' + 'direction, predicateString, and toVisible. Specify one of these';
        throw new _appiumBaseDriver.errors.BadParametersError(msg);

      case 23:
        element = opts.element.ELEMENT ? opts.element.ELEMENT : opts.element;
        endpoint = '/uiaElement/' + element + '/scroll';
        context$1$0.next = 27;
        return _regeneratorRuntime.awrap(this.proxyCommand(endpoint, 'POST', params));

      case 27:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 28:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.getCoordinates = function callee$0$0(gesture) {
  var el, coordinates, rect, pos, size, offsetX, offsetY;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = gesture.options.element;
        coordinates = { x: 0, y: 0, areOffsets: false };

        if (!el) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getRect(el));

      case 5:
        rect = context$1$0.sent;
        pos = { x: rect.x, y: rect.y };
        size = { w: rect.width, h: rect.height };
        offsetX = 0;
        offsetY = 0;

        // get the real offsets
        if (gesture.options.x || gesture.options.y) {
          offsetX = gesture.options.x || 0;
          offsetY = gesture.options.y || 0;
        } else {
          offsetX = size.w / 2;
          offsetY = size.h / 2;
        }

        // apply the offsets
        coordinates.x = pos.x + offsetX;
        coordinates.y = pos.y + offsetY;
        context$1$0.next = 18;
        break;

      case 15:
        // moveTo coordinates are passed in as offsets
        coordinates.areOffsets = gesture.action === 'moveTo';
        coordinates.x = gesture.options.x || 0;
        coordinates.y = gesture.options.y || 0;

      case 18:
        return context$1$0.abrupt('return', coordinates);

      case 19:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.applyMoveToOffset = function (firstCoordinates, secondCoordinates) {
  if (secondCoordinates.areOffsets) {
    return {
      x: firstCoordinates.x + secondCoordinates.x,
      y: firstCoordinates.y + secondCoordinates.y
    };
  } else {
    return secondCoordinates;
  }
};

_Object$assign(extensions, helpers, commands);
exports.extensions = extensions;
exports.helpers = helpers;
exports.commands = commands;
exports['default'] = extensions;

// atoms-based clicks don't always work in safari 7
/*actions, elementId*/
// use the to-visible option of scrolling in WDA

// otherwise, for now, just translate into a drag with short duration

// get gestures

// get drag data

// WDA supports four scrolling strategies: predication based on name, direction,
// predicateString, and toVisible, in that order.

// defaults

// figure out the element coordinates.

// defaults
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZXN0dXJlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBdUIsb0JBQW9COzs2QkFDdEIsZ0JBQWdCOzsrQkFDVCxtQkFBbUI7O3NCQUMvQixXQUFXOzs7O0FBRzNCLElBQUksT0FBTyxHQUFHLEVBQUU7SUFBRSxVQUFVLEdBQUcsRUFBRTtJQUFFLFFBQVEsR0FBRyxFQUFFLENBQUM7O0FBRWpELFFBQVEsQ0FBQyxNQUFNLEdBQUcsNkJBQVksT0FBTyxDQUFDLE1BQU0sQ0FBQzs7QUFFN0MsUUFBUSxDQUFDLEtBQUssR0FBRyxvQkFBZ0IsRUFBRTtNQVMzQixZQUFZOzs7O1lBUmIsSUFBSSxDQUFDLFlBQVksRUFBRTs7Ozs7Y0FDaEIsSUFBSSx5QkFBTyxZQUFZLENBQUMsa0NBQWtDLENBQUM7OztBQUVuRSxVQUFFLEdBQUcsb0JBQUssYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDOztjQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTs7Ozs7O3lDQUUxQyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQzs7Ozs7OztBQUV2QixvQkFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDOzt5Q0FDOUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxZQUFZLENBQUMsQ0FBQzs7Ozs7Ozs7OztDQUV6RCxDQUFDOztBQUVGLFFBQVEsQ0FBQyxZQUFZLEdBQUcsb0JBQWdCLFFBQVE7Ozs7YUFDMUMsS0FBSyxDQUFDLFFBQVEsQ0FBQzs7Ozs7O3lDQUNKLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDOzs7Ozs7Y0FDL0IsUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFBLENBQUUsTUFBTSxDQUFDLFdB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R0FDSCxNQUFNO0FBQ0wsV0FBTyxpQkFBaUIsQ0FBQztHQUMxQjtDQUNGLENBQUM7O0FBRUYsZUFBYyxVQUFVLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3BDLFVBQVUsR0FBVixVQUFVO1FBQUUsT0FBTyxHQUFQLE9BQU87UUFBRSxRQUFRLEdBQVIsUUFBUTtxQkFDdkIsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvZ2VzdHVyZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgaW9zQ29tbWFuZHMgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5cblxubGV0IGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9LCBjb21tYW5kcyA9IHt9O1xuXG5jb21tYW5kcy5tb3ZlVG8gPSBpb3NDb21tYW5kcy5nZXN0dXJlLm1vdmVUbztcblxuY29tbWFuZHMuY2xpY2sgPSBhc3luYyBmdW5jdGlvbiAoZWwpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoJ0NvbW1hbmQgc2hvdWxkIGJlIHByb3hpZWQgdG8gV0RBJyk7XG4gIH1cbiAgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQoZWwpO1xuICBpZiAodGhpcy5vcHRzLm5hdGl2ZVdlYlRhcCAmJiAhdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIC8vIGF0b21zLWJhc2VkIGNsaWNrcyBkb24ndCBhbHdheXMgd29yayBpbiBzYWZhcmkgN1xuICAgIGF3YWl0IHRoaXMubmF0aXZlV2ViVGFwKGVsKTtcbiAgfSBlbHNlIHtcbiAgICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdjbGljaycsIFthdG9tc0VsZW1lbnRdKTtcbiAgfVxufTtcblxuY29tbWFuZHMucGVyZm9ybVRvdWNoID0gYXN5bmMgZnVuY3Rpb24gKGdlc3R1cmVzKSB7XG4gIGlmIChpc1RhcChnZXN0dXJlcykpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5oYW5kbGVUYXAoZ2VzdHVyZXNbMF0pO1xuICB9IGVsc2UgaWYgKGdlc3R1cmVzLmxlbmd0aCA9PT0gMSAmJiAoZ2VzdHVyZXNbMF0gfHwgJycpLmFjdGlvbi50b0xvd2VyQ2FzZSgpID09PSAnZG91YmxldGFwJykge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmhhbmRsZURvdWJsZVRhcChnZXN0dXJlc1swXSk7XG4gIH0gZWxzZSBpZiAoaXNMb25nUHJlc3MoZ2VzdHVyZXMpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuaGFuZGxlTG9uZ1ByZXNzKGdlc3R1cmVzKTtcbiAgfSBlbHNlIGlmIChpc0RyYWcoZ2VzdHVyZXMpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuaGFuZGxlRHJhZyhnZXN0dXJlcyk7XG4gIH0gZWxzZSBpZiAoaXNTY3JvbGwoZ2VzdHVyZXMpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuaGFuZGxlU2Nyb2xsKGdlc3R1cmVzKTtcbiAgfVxuICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoJ1N1cHBvcnQgZm9yIGdlc3R1cmVzIG90aGVyIHRoYW4gVGFwIGlzIG5vdCB5ZXQgaW1wbGVtZW50ZWQuIFBsZWFzZSBjb250YWN0IGFuIEFwcGl1bSBkZXYnKTtcbn07XG5cbmNvbW1hbmRzLnBlcmZvcm1NdWx0aUFjdGlvbiA9IGFzeW5jIGZ1bmN0aW9uICgvKmFjdGlvbnMsIGVsZW1lbnRJZCovKSB7XG4gIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcignU3VwcG9ydCBmb3IgbXVsdGktYWN0aW9uIEFQSSBpcyBub3QgeWV0IGltcGxlbWVudGVkLiBQbGVhc2UgY29udGFjdCBhbiBBcHBpdW0gZGV2LicpO1xufTtcblxuY29tbWFuZHMubmF0aXZlQ2xpY2sgPSBhc3luYyBmdW5jdGlvbiAoZWwpIHtcbiAgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQoZWwpO1xuICBsZXQgZW5kcG9pbnQgPSBgL2VsZW1lbnQvJHtlbH0vY2xpY2tgO1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoZW5kcG9pbnQsICdQT1NUJywge30pO1xufTtcblxuZnVuY3Rpb24gaXNEcmFnIChnZXN0dXJlcykge1xuICByZXR1cm4gKFxuICAgICAgZ2VzdHVyZXMubGVuZ3RoID09PSA0ICYmXG4gICAgICBnZXN0dXJlc1swXS5hY3Rpb24gPT09ICdwcmVzcycgJiZcbiAgICAgIGdlc3R1cmVzWzFdLmFjdGlvbiA9PT0gJ3dhaXQnICYmXG4gICAgICBnZXN0dXJlc1syXS5hY3Rpb24gPT09ICdtb3ZlVG8nICYmXG4gICAgICBnZXN0dXJlc1szXS5hY3Rpb24gPT09ICdyZWxlYXNlJ1xuICApO1xufVxuXG5mdW5jdGlvbiBpc1RhcCAoZ2VzdHVyZXMpIHtcbiAgaWYgKGdlc3R1cmVzLmxlbmd0aCA9PT0gMSAmJiBnZXN0dXJlc1swXS5hY3Rpb24gPT09ICd0YXAnKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gZWxzZSBpZiAoZ2VzdHVyZXMubGVuZ3RoID09PSAyICYmXG4gICAgICAgICAgICAgIGdlc3R1cmVzWzBdLmFjdGlvbiA9PT0gJ3ByZXNzJyAmJlxuICAgICAgICAgICAgICBnZXN0dXJlc1sxXS5hY3Rpb24gPT09ICdyZWxlYXNlJykge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gaXNMb25nUHJlc3MgKGdlc3R1cmVzKSB7XG4gIGlmIChnZXN0dXJlcy5sZW5ndGggPT09IDEgJiYgZ2VzdHVyZXNbMF0uYWN0aW9uLnRvTG93ZXJDYXNlKCkgPT09ICdsb25ncHJlc3MnKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gZWxzZSBpZiAoZ2VzdHVyZXMubGVuZ3RoID09PSAzICYmXG4gICAgICAgICAgICAgIGdlc3R1cmVzWzBdLmFjdGlvbiA9PT0gJ3ByZXNzJyAmJlxuICAgICAgICAgICAgICBnZXN0dXJlc1sxXS5hY3Rpb24gPT09ICd3YWl0JyAmJlxuICAgICAgICAgICAgICBnZXN0dXJlc1syXS5hY3Rpb24gPT09ICdyZWxlYXNlJykge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gaXNTY3JvbGwgKGdlc3R1cmVzKSB7XG4gIGlmIChnZXN0dXJlcy5sZW5ndGggPT09IDMgJiZcbiAgICAgICAgZ2VzdHVyZXNbMF0uYWN0aW9uID09PSAncHJlc3MnICYmXG4gICAgICAgIGdlc3R1cmVzWzFdLmFjdGlvbiA9PT0gJ21vdmVUbycgJiZcbiAgICAgICAgZ2VzdHVyZXNbMl0uYWN0aW9uID09PSAncmVsZWFzZScpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmhlbHBlcnMuaGFuZGxlU2Nyb2xsID0gYXN5bmMgZnVuY3Rpb24gKGdlc3R1cmVzKSB7XG4gIGlmIChnZXN0dXJlc1sxXS5vcHRpb25zLmVsZW1lbnQpIHtcbiAgICAvLyB1c2UgdGhlIHRvLXZpc2libGUgb3B0aW9uIG9mIHNjcm9sbGluZyBpbiBXREFcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5tb2JpbGVTY3JvbGwoe1xuICAgICAgZWxlbWVudDogZ2VzdHVyZXNbMV0ub3B0aW9ucy5lbGVtZW50LFxuICAgICAgdG9WaXNpYmxlOiB0cnVlXG4gICAgfSk7XG4gIH1cblxuICAvLyBvdGhlcndpc2UsIGZvciBub3csIGp1c3QgdHJhbnNsYXRlIGludG8gYSBkcmFnIHdpdGggc2hvcnQgZHVyYXRpb25cbiAgbGV0IGRyYWdHZXN0dXJlcyA9IFtcbiAgICBnZXN0dXJlc1swXSxcbiAgICB7YWN0aW9uOiAnd2FpdCcsIG9wdGlvbnM6IHttczogMH19LFxuICAgIGdlc3R1cmVzWzFdLFxuICAgIGdlc3R1cmVzWzJdXG4gIF07XG4gIHJldHVybiBhd2FpdCB0aGlzLmhhbmRsZURyYWcoZHJhZ0dlc3R1cmVzKTtcbn07XG5cbmhlbHBlcnMuaGFuZGxlRHJhZyA9IGFzeW5jIGZ1bmN0aW9uIChnZXN0dXJlcykge1xuICAvLyBnZXQgZ2VzdHVyZXNcbiAgbGV0IHByZXNzID0gZ2VzdHVyZXNbMF07XG4gIGxldCB3YWl0ID0gZ2VzdHVyZXNbMV07XG4gIGxldCBtb3ZlVG8gPSBnZXN0dXJlc1syXTtcblxuICAvLyBnZXQgZHJhZyBkYXRhXG4gIGxldCBwcmVzc0Nvb3JkaW5hdGVzID0gYXdhaXQgdGhpcy5nZXRDb29yZGluYXRlcyhwcmVzcyk7XG4gIGxldCBkdXJhdGlvbiA9IChwYXJzZUludCh3YWl0Lm9wdGlvbnMubXMsIDEwKSAvIDEwMDApO1xuICBsZXQgbW92ZVRvQ29vcmRpbmF0ZXMgPSBhd2FpdCB0aGlzLmdldENvb3JkaW5hdGVzKG1vdmVUbyk7XG5cbiAgLy8gdXBkYXRlIG1vdmVUbyBjb29yZGluYXRlcyB3aXRoIG9mZnNldFxuICBtb3ZlVG9Db29yZGluYXRlcyA9IHRoaXMuYXBwbHlNb3ZlVG9PZmZzZXQocHJlc3NDb29yZGluYXRlcywgbW92ZVRvQ29vcmRpbmF0ZXMpO1xuXG4gIC8vIGJ1aWxkIGRyYWcgY29tbWFuZFxuICBsZXQgcGFyYW1zID0ge307XG4gIHBhcmFtcy5mcm9tWCA9IHByZXNzQ29vcmRpbmF0ZXMueDtcbiAgcGFyYW1zLmZyb21ZID0gcHJlc3NDb29yZGluYXRlcy55O1xuICBwYXJhbXMudG9YID0gbW92ZVRvQ29vcmRpbmF0ZXMueDtcbiAgcGFyYW1zLnRvWSA9IG1vdmVUb0Nvb3JkaW5hdGVzLnk7XG4gIHBhcmFtcy5kdXJhdGlvbiA9IGR1cmF0aW9uO1xuXG4gIGxldCBlbmRwb2ludCA9IGAvdWlhVGFyZ2V0LzAvZHJhZ2Zyb210b2ZvcmR1cmF0aW9uYDtcbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGVuZHBvaW50LCAnUE9TVCcsIHBhcmFtcyk7XG59O1xuXG5oZWxwZXJzLmhhbmRsZVRhcCA9IGFzeW5jIGZ1bmN0aW9uIChnZXN0dXJlKSB7XG4gIGxldCBvcHRpb25zID0gZ2VzdHVyZS5vcHRpb25zIHx8IHt9O1xuXG4gIGxldCBwYXJhbXMgPSB7fTtcbiAgaWYgKHV0aWwuaGFzVmFsdWUob3B0aW9ucy54KSAmJiB1dGlsLmhhc1ZhbHVlKG9wdGlvbnMueSkpIHtcbiAgICBwYXJhbXMueCA9IG9wdGlvbnMueDtcbiAgICBwYXJhbXMueSA9IG9wdGlvbnMueTtcbiAgfVxuXG4gIGxldCBlbCA9IHV0aWwuaGFzVmFsdWUob3B0aW9ucy5lbGVtZW50KSA/IG9wdGlvbnMuZWxlbWVudCA6ICcnO1xuICBsZXQgZW5kcG9pbnQgPSBgL3RhcC8ke2VsfWA7XG5cbiAgaWYgKHV0aWwuaGFzVmFsdWUodGhpcy5vcHRzLnRhcFdpdGhTaG9ydFByZXNzRHVyYXRpb24pKSB7XG4gICAgLy8gaW4gc29tZSBjYXNlcyBgdGFwYCBpcyB0b28gc2xvdywgc28gYWxsb3cgY29uZmlndXJhYmxlIGxvbmcgcHJlc3NcbiAgICBsb2cuZGVidWcoYFRyYW5zbGF0aW5nIHRhcCBpbnRvIGxvbmcgcHJlc3Mgd2l0aCAnJHt0aGlzLm9wdHMudGFwV2l0aFNob3J0UHJlc3NEdXJhdGlvbn0nIGR1cmF0aW9uYCk7XG4gICAgcGFyYW1zLmR1cmF0aW9uID0gcGFyc2VGbG9hdCh0aGlzLm9wdHMudGFwV2l0aFNob3J0UHJlc3NEdXJhdGlvbik7XG4gICAgZW5kcG9pbnQgPSBgL3VpYUVsZW1lbnQvJHtlbH0vdG91Y2hBbmRIb2xkYDtcbiAgICBwYXJhbXMuZHVyYXRpb24gPSBwYXJzZUZsb2F0KHRoaXMub3B0cy50YXBXaXRoU2hvcnRQcmVzc0R1cmF0aW9uKTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChlbmRwb2ludCwgJ1BPU1QnLCBwYXJhbXMpO1xufTtcblxuaGVscGVycy5oYW5kbGVEb3VibGVUYXAgPSBhc3luYyBmdW5jdGlvbiAoZ2VzdHVyZSkge1xuICBsZXQgb3B0cyA9IGdlc3R1cmUub3B0aW9ucyB8fCB7fTtcblxuICBpZiAoIW9wdHMuZWxlbWVudCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuQmFkUGFyYW1ldGVyc0Vycm9yKCdXREEgZG91YmxlIHRhcCBuZWVkcyBhbiBlbGVtZW50Jyk7XG4gIH1cblxuICBsZXQgZWwgPSBvcHRzLmVsZW1lbnQuRUxFTUVOVCA/IG9wdHMuZWxlbWVudC5FTEVNRU5UIDogb3B0cy5lbGVtZW50O1xuICBsZXQgZW5kcG9pbnQgPSBgL3VpYUVsZW1lbnQvJHtlbH0vZG91YmxlVGFwYDtcblxuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoZW5kcG9pbnQsICdQT1NUJyk7XG59O1xuXG5oZWxwZXJzLmhhbmRsZUxvbmdQcmVzcyA9IGFzeW5jIGZ1bmN0aW9uIChnZXN0dXJlcykge1xuICBsZXQgcHJlc3NPcHRzID0gZ2VzdHVyZXNbMF0ub3B0aW9ucyB8fCB7fTtcblxuICBsZXQgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQocHJlc3NPcHRzLmVsZW1lbnQpO1xuICBpZiAoIWVsKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5CYWRQYXJhbWV0ZXJzRXJyb3IoJ1dEQSBsb25nIHByZXNzIG5lZWRzIGFuIGVsZW1lbnQnKTtcbiAgfVxuXG4gIGxldCBkdXJhdGlvbiA9IDAuODtcbiAgaWYgKGdlc3R1cmVzLmxlbmd0aCA9PT0gMSAmJiB1dGlsLmhhc1ZhbHVlKHByZXNzT3B0cy5kdXJhdGlvbikpIHtcbiAgICBkdXJhdGlvbiA9IHByZXNzT3B0cy5kdXJhdGlvbjtcbiAgfSBlbHNlIGlmIChnZXN0dXJlcy5sZW5ndGggPT09IDMpIHtcbiAgICAvLyBkdXJhdGlvbiBpcyB0aGUgYHdhaXRgIGFjdGlvblxuICAgIC8vIHVwc3RyZWFtIHN5c3RlbSBleHBlY3RzIHNlY29uZHMgbm90IG1pbGxpc2Vjb25kc1xuICAgIGR1cmF0aW9uID0gcGFyc2VGbG9hdChnZXN0dXJlc1sxXS5vcHRpb25zLm1zKSAvIDEwMDA7XG4gIH1cblxuICBsZXQgcGFyYW1zID0ge1xuICAgIGR1cmF0aW9uXG4gIH07XG5cbiAgbGV0IGVuZHBvaW50ID0gYC91aWFFbGVtZW50LyR7ZWx9L3RvdWNoQW5kSG9sZGA7XG5cbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGVuZHBvaW50LCAnUE9TVCcsIHBhcmFtcyk7XG59O1xuXG5oZWxwZXJzLm1vYmlsZVNjcm9sbCA9IGFzeW5jIGZ1bmN0aW9uIChvcHRzPXt9KSB7XG4gIGlmICghb3B0cy5lbGVtZW50KSB7XG4gICAgb3B0cy5lbGVtZW50ID0gYXdhaXQgdGhpcy5maW5kRWxlbWVudChgY2xhc3MgbmFtZWAsIGBYQ1VJRWxlbWVudFR5cGVBcHBsaWNhdGlvbmApO1xuICB9XG4gIC8vIFdEQSBzdXBwb3J0cyBmb3VyIHNjcm9sbGluZyBzdHJhdGVnaWVzOiBwcmVkaWNhdGlvbiBiYXNlZCBvbiBuYW1lLCBkaXJlY3Rpb24sXG4gIC8vIHByZWRpY2F0ZVN0cmluZywgYW5kIHRvVmlzaWJsZSwgaW4gdGhhdCBvcmRlci5cbiAgbGV0IHBhcmFtcyA9IHt9O1xuICBpZiAob3B0cy5uYW1lKSB7XG4gICAgcGFyYW1zLm5hbWUgPSBvcHRzLm5hbWU7XG4gIH0gZWxzZSBpZiAob3B0cy5kaXJlY3Rpb24pIHtcbiAgICBwYXJhbXMuZGlyZWN0aW9uID0gb3B0cy5kaXJlY3Rpb247XG4gIH0gZWxzZSBpZiAob3B0cy5wcmVkaWNhdGVTdHJpbmcpIHtcbiAgICBwYXJhbXMucHJlZGljYXRlU3RyaW5nID0gb3B0cy5wcmVkaWNhdGVTdHJpbmc7XG4gIH0gZWxzZSBpZiAob3B0cy50b1Zpc2libGUpIHtcbiAgICBwYXJhbXMudG9WaXNpYmxlID0gb3B0cy50b1Zpc2libGU7XG4gIH0gZWxzZSB7XG4gICAgbGV0IG1zZyA9ICdNb2JpbGUgc2Nyb2xsIHN1cHBvcnRzIHRoZSBmb2xsb3dpbmcgc3RyYXRlZ2llczogbmFtZSwgJyArXG4gICAgICAgICAgICAgICdkaXJlY3Rpb24sIHByZWRpY2F0ZVN0cmluZywgYW5kIHRvVmlzaWJsZS4gU3BlY2lmeSBvbmUgb2YgdGhlc2UnO1xuICAgIHRocm93IG5ldyBlcnJvcnMuQmFkUGFyYW1ldGVyc0Vycm9yKG1zZyk7XG4gIH1cblxuICBsZXQgZWxlbWVudCA9IG9wdHMuZWxlbWVudC5FTEVNRU5UID8gb3B0cy5lbGVtZW50LkVMRU1FTlQgOiBvcHRzLmVsZW1lbnQ7XG4gIGxldCBlbmRwb2ludCA9IGAvdWlhRWxlbWVudC8ke2VsZW1lbnR9L3Njcm9sbGA7XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChlbmRwb2ludCwgJ1BPU1QnLCBwYXJhbXMpO1xufTtcblxuaGVscGVycy5nZXRDb29yZGluYXRlcyA9IGFzeW5jIGZ1bmN0aW9uKGdlc3R1cmUpIHtcbiAgbGV0IGVsID0gZ2VzdHVyZS5vcHRpb25zLmVsZW1lbnQ7XG5cbiAgLy8gZGVmYXVsdHNcbiAgbGV0IGNvb3JkaW5hdGVzID0ge3g6IDAsIHk6IDAsIGFyZU9mZnNldHM6IGZhbHNlfTtcblxuICAvLyBmaWd1cmUgb3V0IHRoZSBlbGVtZW50IGNvb3JkaW5hdGVzLlxuICBpZiAoZWwpIHtcbiAgICBsZXQgcmVjdCA9IGF3YWl0IHRoaXMuZ2V0UmVjdChlbCk7XG4gICAgbGV0IHBvcyA9IHt4OiByZWN0LngsIHk6IHJlY3QueX07XG4gICAgbGV0IHNpemUgPSB7dzogcmVjdC53aWR0aCwgaDogcmVjdC5oZWlnaHR9O1xuXG4gICAgLy8gZGVmYXVsdHNcbiAgICBsZXQgb2Zmc2V0WCA9IDA7XG4gICAgbGV0IG9mZnNldFkgPSAwO1xuXG4gICAgLy8gZ2V0IHRoZSByZWFsIG9mZnNldHNcbiAgICBpZiAoZ2VzdHVyZS5vcHRpb25zLnggfHwgZ2VzdHVyZS5vcHRpb25zLnkpIHtcbiAgICAgIG9mZnNldFggPSAoZ2VzdHVyZS5vcHRpb25zLnggfHwgMCk7XG4gICAgICBvZmZzZXRZID0gKGdlc3R1cmUub3B0aW9ucy55IHx8IDApO1xuICAgIH0gZWxzZSB7XG4gICAgICBvZmZzZXRYID0gKHNpemUudyAvIDIpO1xuICAgICAgb2Zmc2V0WSA9IChzaXplLmggLyAyKTtcbiAgICB9XG5cbiAgICAvLyBhcHBseSB0aGUgb2Zmc2V0c1xuICAgIGNvb3JkaW5hdGVzLnggPSBwb3MueCArIG9mZnNldFg7XG4gICAgY29vcmRpbmF0ZXMueSA9IHBvcy55ICsgb2Zmc2V0WTtcbiAgfSBlbHNlIHtcbiAgICAvLyBtb3ZlVG8gY29vcmRpbmF0ZXMgYXJlIHBhc3NlZCBpbiBhcyBvZmZzZXRzXG4gICAgY29vcmRpbmF0ZXMuYXJlT2Zmc2V0cyA9IChnZXN0dXJlLmFjdGlvbiA9PT0gJ21vdmVUbycpO1xuICAgIGNvb3JkaW5hdGVzLnggPSAoZ2VzdHVyZS5vcHRpb25zLnggfHwgMCk7XG4gICAgY29vcmRpbmF0ZXMueSA9IChnZXN0dXJlLm9wdGlvbnMueSB8fCAwKTtcbiAgfVxuICByZXR1cm4gY29vcmRpbmF0ZXM7XG59O1xuXG5oZWxwZXJzLmFwcGx5TW92ZVRvT2Zmc2V0ID0gZnVuY3Rpb24gKGZpcnN0Q29vcmRpbmF0ZXMsIHNlY29uZENvb3JkaW5hdGVzKSB7XG4gIGlmIChzZWNvbmRDb29yZGluYXRlcy5hcmVPZmZzZXRzKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHg6IGZpcnN0Q29vcmRpbmF0ZXMueCArIHNlY29uZENvb3JkaW5hdGVzLngsXG4gICAgICB5OiBmaXJzdENvb3JkaW5hdGVzLnkgKyBzZWNvbmRDb29yZGluYXRlcy55LFxuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHNlY29uZENvb3JkaW5hdGVzO1xuICB9XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGhlbHBlcnMsIGNvbW1hbmRzKTtcbmV4cG9ydCB7IGV4dGVuc2lvbnMsIGhlbHBlcnMsIGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
