'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _teen_process = require('teen_process');

var _appiumSupport = require('appium-support');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var IOSDEPLOY_PATH = 'ios-deploy';

var IOSDeploy = (function () {
  function IOSDeploy(udid) {
    _classCallCheck(this, IOSDeploy);

    this.udid = udid;
    this.cmd = IOSDEPLOY_PATH; // this.cmd is in accordance with iDevice
  }

  _createClass(IOSDeploy, [{
    key: 'checkStatus',
    value: function checkStatus() {
      return _regeneratorRuntime.async(function checkStatus$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.which(this.cmd));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'remove',
    value: function remove(bundleid) {
      var remove;
      return _regeneratorRuntime.async(function remove$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            remove = ['--uninstall_only', '--id', this.udid, '--bundle_id', bundleid];
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.cmd, remove, { maxBuffer: 524288 }));

          case 4:
            context$2$0.next = 10;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].debug('Error : ' + context$2$0.t0.message);
            throw new Error('Could not remove app ' + context$2$0.t0.message);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }, {
    key: 'install',
    value: function install(app) {
      var install;
      return _regeneratorRuntime.async(function install$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            install = ['--id', this.udid, '--uninstall', '--bundle', app];
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.cmd, install, { maxBuffer: 524288 }));

          case 4:
            context$2$0.next = 10;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].debug('Error : ' + context$2$0.t0.message);
            throw new Error('Could not install app ' + context$2$0.t0.message);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }, {
    key: 'isInstalled',
    value: function isInstalled(bundleid) {
      var isInstalled, _ref, stdout;

      return _regeneratorRuntime.async(function isInstalled$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            isInstalled = ['--exists', '--id', this.udid, '--bundle_id', bundleid];
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.cmd, isInstalled, { maxBuffer: 524288 }));

          case 4:
            _ref = context$2$0.sent;
            stdout = _ref.stdout;
            return context$2$0.abrupt('return', stdout && stdout.indexOf("true") > -1);

          case 9:
            context$2$0.prev = 9;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].debug('Error checking install status: ' + context$2$0.t0.message);
            return context$2$0.abrupt('return', false);

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 9]]);
    }
  }]);

  return IOSDeploy;
})();

exports['default'] = IOSDeploy;
module.exports = exports['default'];

// make sure we actually have the program
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pb3MtZGVwbG95LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OzRCQUFxQixjQUFjOzs2QkFDaEIsZ0JBQWdCOztzQkFDaEIsVUFBVTs7OztBQUU3QixJQUFNLGNBQWMsZUFBZSxDQUFDOztJQUU5QixTQUFTO0FBRUQsV0FGUixTQUFTLENBRUEsSUFBSSxFQUFFOzBCQUZmLFNBQVM7O0FBR1gsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDakIsUUFBSSxDQUFDLEdBQUcsR0FBRyxjQUFjLENBQUM7R0FDM0I7O2VBTEcsU0FBUzs7V0FPSzs7Ozs7NkNBRVYsa0JBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7Ozs7Ozs7S0FDekI7OztXQUVZLGdCQUFDLFFBQVE7VUFDaEIsTUFBTTs7OztBQUFOLGtCQUFNLEdBQUcsNkJBQTZCLElBQUksQ0FBQyxJQUFJLGlCQUFpQixRQUFRLENBQUM7Ozs2Q0FFckUsd0JBQUssSUFBSSxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFDLENBQUM7Ozs7Ozs7Ozs7QUFFbEQsZ0NBQU8sS0FBSyxjQUFZLGVBQUksT0FBTyxDQUFHLENBQUM7a0JBQ2pDLElBQUksS0FBSywyQkFBeUIsZUFBSSxPQUFPLENBQUc7Ozs7Ozs7S0FFekQ7OztXQUVhLGlCQUFDLEdBQUc7VUFDWixPQUFPOzs7O0FBQVAsbUJBQU8sR0FBRyxTQUFTLElBQUksQ0FBQyxJQUFJLDZCQUE2QixHQUFHLENBQUM7Ozs2Q0FFekQsd0JBQUssSUFBSSxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFDLENBQUM7Ozs7Ozs7Ozs7QUFFbkQsZ0NBQU8sS0FBSyxjQUFZLGVBQUksT0FBTyxDQUFHLENBQUM7a0JBQ2pDLElBQUksS0FBSyw0QkFBMEIsZUFBSSxPQUFPLENBQUc7Ozs7Ozs7S0FFMUQ7OztXQUVpQixxQkFBQyxRQUFRO1VBQ3JCLFdBQVcsUUFFUixNQUFNOzs7OztBQUZULHVCQUFXLEdBQUcscUJBQXFCLElBQUksQ0FBQyxJQUFJLGlCQUFpQixRQUFRLENBQUM7Ozs2Q0FFbkQsd0JBQUssSUFBSSxDQUFDLEdBQUcsRUFBRSxXQUFXLEVBQUUsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFDLENBQUM7Ozs7QUFBakUsa0JBQU0sUUFBTixNQUFNO2dEQUNILE1BQU0sSUFBSyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxBQUFDOzs7Ozs7QUFFL0MsZ0NBQU8sS0FBSyxxQ0FBbUMsZUFBSSxPQUFPLENBQUcsQ0FBQztnREFDdkQsS0FBSzs7Ozs7OztLQUVmOzs7U0F6Q0csU0FBUzs7O3FCQTRDQSxTQUFTIiwiZmlsZSI6ImxpYi9pb3MtZGVwbG95LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuXG5jb25zdCBJT1NERVBMT1lfUEFUSCA9IGBpb3MtZGVwbG95YDtcblxuY2xhc3MgSU9TRGVwbG95IHtcblxuICBjb25zdHJ1Y3RvciAodWRpZCkge1xuICAgIHRoaXMudWRpZCA9IHVkaWQ7XG4gICAgdGhpcy5jbWQgPSBJT1NERVBMT1lfUEFUSDsvLyB0aGlzLmNtZCBpcyBpbiBhY2NvcmRhbmNlIHdpdGggaURldmljZVxuICB9XG5cbiAgYXN5bmMgY2hlY2tTdGF0dXMgKCkge1xuICAgIC8vIG1ha2Ugc3VyZSB3ZSBhY3R1YWxseSBoYXZlIHRoZSBwcm9ncmFtXG4gICAgYXdhaXQgZnMud2hpY2godGhpcy5jbWQpO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlIChidW5kbGVpZCkge1xuICAgIGxldCByZW1vdmUgPSBbYC0tdW5pbnN0YWxsX29ubHlgLCBgLS1pZGAsIHRoaXMudWRpZCwgYC0tYnVuZGxlX2lkYCwgYnVuZGxlaWRdO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKHRoaXMuY21kLCByZW1vdmUsIHsgbWF4QnVmZmVyOiA1MjQyODh9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgRXJyb3IgOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgcmVtb3ZlIGFwcCAke2Vyci5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluc3RhbGwgKGFwcCkge1xuICAgIGxldCBpbnN0YWxsID0gW2AtLWlkYCwgdGhpcy51ZGlkLCBgLS11bmluc3RhbGxgLCBgLS1idW5kbGVgLCBhcHBdO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKHRoaXMuY21kLCBpbnN0YWxsLCB7IG1heEJ1ZmZlcjogNTI0Mjg4fSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYEVycm9yIDogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGluc3RhbGwgYXBwICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaXNJbnN0YWxsZWQgKGJ1bmRsZWlkKSB7XG4gICAgbGV0IGlzSW5zdGFsbGVkID0gW2AtLWV4aXN0c2AsIGAtLWlkYCwgdGhpcy51ZGlkLCBgLS1idW5kbGVfaWRgLCBidW5kbGVpZF07XG4gICAgdHJ5IHtcbiAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWModGhpcy5jbWQsIGlzSW5zdGFsbGVkLCB7IG1heEJ1ZmZlcjogNTI0Mjg4fSk7XG4gICAgICByZXR1cm4gKHN0ZG91dCAmJiAoc3Rkb3V0LmluZGV4T2YoXCJ0cnVlXCIpID4gLTEpKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgRXJyb3IgY2hlY2tpbmcgaW5zdGFsbCBzdGF0dXM6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IElPU0RlcGxveTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
